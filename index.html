<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Calculator Pro (Final Revisions)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8fafc; --bg-secondary: #fff; --bg-tertiary: #f1f5f9;
            --text-primary: #111827; --text-secondary: #475569; --border-color: #e2e8f0;
            --highlight-yellow: #fef08a; --highlight-green: #bbf7d0; --highlight-red: #fecaca;
            --highlight-blue: #bfdbfe; --highlight-purple: #e9d5ff;
            --brand-color: #4f46e5; --brand-color-light: rgba(79, 70, 229, 0.2);
            --adjustment-up-color: #15803d; --adjustment-down-color: #b91c1c;
        }
        .dark {
            --bg-primary: #111827; --bg-secondary: #1f2937; --bg-tertiary: #374151;
            --text-primary: #f9fafb; --text-secondary: #9ca3af; --border-color: #4b5563;
            --highlight-yellow: #422006; --highlight-green: #14532d; --highlight-red: #450a0a;
            --highlight-blue: #1e40af; --highlight-purple: #581c87;
            --adjustment-up-color: #4ade80; --adjustment-down-color: #f87171;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-primary); 
            color: var(--text-primary); 
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }
        .main-container { width: 95%; max-width: 2400px; margin: auto; background-color: var(--bg-secondary); }
        .hidden { display: none !important; }
        .tab-content { border: 1px solid var(--border-color); border-top: none; padding: 1.5rem; background-color: var(--bg-secondary); border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        .sheet-title-container { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .sheet-title { font-size: 1.875rem; font-weight: 700; border: 2px solid transparent; border-radius: 0.5rem; padding: 0.25rem 0.5rem; background-color: transparent; color: var(--text-primary); transition: all 0.2s ease; flex-grow: 1; }
        .sheet-title:hover { border-color: var(--border-color); }
        .sheet-title:focus { border-color: var(--brand-color); outline: none; background-color: var(--bg-tertiary); }
        .sheet-link-input { width: 40%; }
        .table-container { overflow-x: auto; }
        th { position: sticky; top: 0; z-index: 10; background-color: var(--bg-tertiary); }
        .header-campaign-name { background-color: #f9fafb; }
        .dark .header-campaign-name { background-color: #374151; }
        td, th { padding: 8px; border: 1px solid var(--border-color); text-align: center; white-space: nowrap; position: relative; }
        .input-cell { width: 100px; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); text-align: center; background-color: var(--bg-secondary); color: var(--text-primary); transition: all 0.2s; }
        .input-cell:focus { outline: none; border-color: var(--brand-color); box-shadow: 0 0 0 2px var(--brand-color-light); }
        .campaign-name-input { width: 450px; }
        .campaign-name-cell-container { display: flex; align-items: center; gap: 0.5rem; }
        .link-icon { color: var(--brand-color); cursor: pointer; }
        .output-cell { font-weight: 600; color: #312e81; background-color: #eef2ff; }
        .dark .output-cell { background-color: #3730a3; color: #e0e7ff; }
        .header-tos { background-color: #bae6fd; color: #0c4a6e;} .col-tos { background-color: #f0f9ff; }
        .header-ros { background-color: #bbf7d0; color: #14532d;} .col-ros { background-color: #f0fdf4; }
        .header-pp { background-color: #fde68a; color: #78350f;} .col-pp { background-color: #fefce8; }
        .header-output { background-color: #e0e7ff; color: #312e81; }
        .dark .col-tos { background-color: #0c4a6e; } .dark .col-ros { background-color: #14532d; } .dark .col-pp { background-color: #78350f; }
        .adjustment-up { color: var(--adjustment-up-color); } .adjustment-down { color: var(--adjustment-down-color); }
        .sheet-tabs { display: flex; border-bottom: 2px solid var(--border-color); flex-wrap: wrap; }
        .sheet-tab { display: flex; align-items: center; gap: 0.5rem; padding: 10px 16px; cursor: pointer; border: 1px solid transparent; border-bottom: none; margin-bottom: -2px; color: var(--text-secondary); font-weight: 500; transition: all 0.2s ease; }
        .sheet-tab.active { color: var(--brand-color); border-color: var(--border-color) var(--border-color) var(--bg-secondary); border-top-left-radius: 8px; border-top-right-radius: 8px; background-color: var(--bg-secondary); }
        .sheet-tab:not(.active):hover { background-color: var(--bg-tertiary); border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .delete-sheet-btn { font-size: 1.25rem; line-height: 1; padding: 0 0.25rem; border-radius: 99px; }
        .delete-sheet-btn:hover { background-color: var(--highlight-red); color: #7f1d1d; }
        .btn { background-color: var(--bg-secondary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; color: var(--text-primary); transition: all 0.2s; cursor: pointer; }
        .btn:hover:not(:disabled) { background-color: var(--bg-tertiary); border-color: #9ca3af; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--brand-color); color: white; border-color: var(--brand-color); }
        .btn-danger { background-color: #ef4444; color: white; border-color: #ef4444; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #1f2937; color: #f9fafb; padding: 12px 20px; border-radius: 8px; z-index: 1000; opacity: 0; transition: opacity 0.3s, bottom 0.3s; font-weight: 500; }
        .toast.show { opacity: 1; bottom: 30px; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .modal-box { background-color: var(--bg-secondary); padding: 2rem; border-radius: 0.5rem; max-width: 500px; width: 90%; text-align: left; }
        .active-row { background-color: var(--highlight-yellow) !important; opacity: 0.7; }
        .highlight-palette { display: flex; gap: 0.5rem; align-items: center; }
        .color-swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid var(--border-color); transition: transform 0.2s ease; }
        .color-swatch:hover { transform: scale(1.1); }
        .row-flash { animation: flash 0.7s ease-out; }
        @keyframes flash { 0% { background-color: var(--brand-color-light); } 100% { background-color: transparent; } }
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--brand-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .settings-section.disabled { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">

    <div class="main-container rounded-2xl shadow-lg">
        <div class="p-6">
            <!-- Header -->
            <header class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold">Campaign Calculator</h1>
                <div class="flex items-center gap-4">
                    <button id="undo-btn" class="btn p-2" title="Undo (Ctrl+Z)" aria-label="Undo last action" disabled>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    </button>
                    <button id="redo-btn" class="btn p-2" title="Redo (Ctrl+Y)" aria-label="Redo last action" disabled>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>
                    <button id="save-btn" class="btn" title="Force save and create a history point">Save</button>
                    <div id="theme-switcher" class="flex items-center cursor-pointer p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="Toggle Theme" aria-label="Toggle color theme">
                        <svg id="theme-icon-sun" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-15.66l-.7.7M4.04 19.96l-.7.7M21 12h-1M4 12H3m15.66 8.66l-.7-.7M4.04 4.04l-.7-.7M12 18a6 6 0 100-12 6 6 0 000 12z"></path></svg>
                        <svg id="theme-icon-moon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </div>
                </div>
            </header>

            <!-- Main Tabs -->
            <nav id="main-tabs-container" class="sheet-tabs">
                <div class="sheet-tab active" data-tab="calculator">Calculator</div>
                <div class="sheet-tab" data-tab="instructions">Instructions</div>
                <div class="sheet-tab" data-tab="settings">Settings</div>
            </nav>

            <!-- Main Content Area -->
            <main id="main-content">
                <!-- Views are dynamically inserted here from templates -->
            </main>
        </div>
    </div>
    
    <!-- Toast & Modal Placeholders -->
    <div id="toast-container" class="toast"></div>
    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Are you sure?</h3>
            <p id="modal-message" class="mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="modal-cancel-btn" class="btn">Cancel</button>
                <button id="modal-confirm-btn" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <!-- View Templates -->
    <template id="calculator-view-template">
        <div id="calculator-view" class="tab-content">
            <div id="sheet-tabs-container" class="sheet-tabs"></div>
            <div id="sheet-content" class="pt-4">
                <div class="sheet-title-container">
                    <input type="text" id="sheet-title-input" class="sheet-title" value="Sheet Title" aria-label="Sheet Title">
                    <input type="text" id="sheet-link-input" class="input-cell sheet-link-input" placeholder="Paste link for this sheet...">
                </div>
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <div id="bulk-actions-container" class="flex gap-4 items-center">
                        <button id="delete-selected-btn" class="btn btn-danger" disabled>Delete Selected</button>
                        <button id="copy-selected-btn" class="btn" disabled>Copy Selected</button>
                        <div id="highlight-palette-container" class="highlight-palette hidden">
                            <div class="color-swatch" style="background-color: var(--highlight-green);" data-color="green" aria-label="Highlight green"></div>
                            <div class="color-swatch" style="background-color: var(--highlight-red);" data-color="red" aria-label="Highlight red"></div>
                            <div class="color-swatch" style="background-color: var(--highlight-blue);" data-color="blue" aria-label="Highlight blue"></div>
                            <div class="color-swatch" style="background-color: var(--highlight-yellow);" data-color="yellow" aria-label="Highlight yellow"></div>
                            <div class="color-swatch" style="background-color: var(--highlight-purple);" data-color="purple" aria-label="Highlight purple"></div>
                            <div class="color-swatch" style="background-color: transparent; border: 2px dashed var(--text-secondary);" data-color="none" title="Clear Highlight" aria-label="Clear highlight"></div>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button id="import-csv-btn" class="btn">Import CSV</button>
                        <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                        <button id="export-csv-btn" class="btn">Export CSV</button>
                    </div>
                </div>
                <div class="table-container rounded-lg border" style="border-color: var(--border-color);">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th class="w-12"><input type="checkbox" id="select-all-checkbox" aria-label="Select all rows"></th>
                                <th class="header-campaign-name">Campaign Name</th>
                                <th class="header-tos">TOS CPC</th><th class="header-tos">TOS ACOS %</th>
                                <th class="header-ros">ROS CPC</th><th class="header-ros">ROS ACOS %</th>
                                <th class="header-pp">PP CPC</th><th class="header-pp">PP ACOS %</th>
                                <th class="header-output">New Bid</th>
                                <th class="header-output">TOS Adjust</th>
                                <th class="header-output">ROS Adjust</th>
                                <th class="header-output">PP Adjust</th>
                                <th class="header-output">Link</th>
                            </tr>
                        </thead>
                        <tbody id="campaign-table-body"></tbody>
                    </table>
                </div>
                <div class="mt-6 flex justify-center">
                    <button id="add-row-btn" class="btn btn-primary">Add Campaign</button>
                </div>
            </div>
        </div>
    </template>
    
    <template id="instructions-view-template">
        <div id="instructions-view" class="tab-content">
            <div class="prose dark:prose-invert lg:prose-xl max-w-none">
                <h2>Welcome to Campaign Calculator Pro!</h2>
                <p>This tool is designed to streamline your campaign bid adjustments. Here’s how to use its powerful features:</p>
                <h3>Core Functionality</h3>
                <ul>
                    <li><strong>Data Entry:</strong> Fill in the CPC and ACOS % for each placement: Top of Search (TOS), Rest of Search (ROS), and Product Pages (PP).</li>
                    <li><strong>Calculations:</strong> The tool instantly calculates a final <strong>New Bid</strong> (the lowest potential bid across all placements) and then shows the percentage <strong>Increase</strong> needed for the other placements to match their ideal bids.</li>
                    <li><strong>Undo/Redo:</strong> Use the Undo/Redo buttons or Ctrl+Z/Ctrl+Y to reverse your actions.</li>
                </ul>
                <h3>Sheet Management</h3>
                <ul>
                    <li><strong>Multiple Sheets:</strong> You can work with multiple separate sheets. Click a tab to switch, the <strong>+</strong> button to add, or the <strong>×</strong> to delete (with confirmation).</li>
                    <li><strong>Custom Settings:</strong> Go to the Settings tab to define Global Default rules. You can then choose to override these defaults for any specific sheet by enabling "Use Custom Settings". A ⚙️ icon will appear on the sheet tab as a reminder.</li>
                </ul>
            </div>
            <hr class="my-8" style="border-color: var(--border-color);">
            <div>
                <h3 class="text-xl font-bold mb-4">My Notes</h3>
                <textarea id="notes-textarea" class="w-full p-2 border rounded-md h-64" style="background-color: var(--bg-tertiary); border-color: var(--border-color);" placeholder="Type your personal notes here... they will be saved automatically."></textarea>
            </div>
        </div>
    </template>

    <template id="settings-view-template">
        <div id="settings-view" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Column 1: Global/Sheet Settings -->
                <div class="lg:col-span-2 space-y-6">
                    <div id="global-settings-container" class="p-4 border rounded-lg settings-section" style="border-color: var(--border-color);">
                        <h3 class="text-xl font-bold mb-4">Global Default Settings</h3>
                        <p class="text-sm text-gray-500 mb-4">These settings apply to all sheets unless custom settings are enabled for a specific sheet.</p>
                        <div class="space-y-6">
                            <div>
                                <h4 class="text-lg font-semibold mb-3">ACOS Logic Table</h4>
                                <div id="global-acos-logic-table-container"></div>
                                <button id="add-global-logic-rule-btn" class="btn mt-3 w-full">Add Rule</button>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold mb-3">Conditional Formatting</h4>
                                <div id="global-conditional-formatting-container"></div>
                                <button id="add-global-formatting-rule-btn" class="btn mt-3 w-full">Add Rule</button>
                            </div>
                        </div>
                    </div>
                    <div id="sheet-settings-container" class="p-4 border rounded-lg" style="border-color: var(--border-color);">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Settings for <span id="settings-sheet-name" class="text-indigo-600 dark:text-indigo-400"></span></h3>
                            <div class="flex items-center gap-3">
                                <span class="font-medium text-sm">Use Custom Settings</span>
                                <label class="switch">
                                    <input type="checkbox" id="use-custom-settings-toggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                        <div id="custom-settings-editors" class="hidden space-y-6 settings-section">
                             <div>
                                <h4 class="text-lg font-semibold mb-3">Custom ACOS Logic Table</h4>
                                <div id="sheet-acos-logic-table-container"></div>
                                <button id="add-sheet-logic-rule-btn" class="btn mt-3 w-full">Add Rule</button>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold mb-3">Custom Conditional Formatting</h4>
                                <div id="sheet-conditional-formatting-container"></div>
                                <button id="add-sheet-formatting-rule-btn" class="btn mt-3 w-full">Add Rule</button>
                            </div>
                        </div>
                         <p id="using-global-settings-msg" class="text-center text-gray-500 p-4 bg-gray-50 dark:bg-gray-800 rounded-md">This sheet is currently using the Global Default Settings.</p>
                    </div>
                </div>
                <!-- Column 2: Presets -->
                <div class="p-4 border rounded-lg" style="border-color: var(--border-color);">
                    <h3 class="text-xl font-bold mb-6">Presets</h3>
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold">Save Settings</h4>
                        <div class="flex gap-2">
                            <input type="text" id="preset-name-input" placeholder="New Preset Name" class="input-cell flex-grow">
                            <button id="save-preset-btn" class="btn btn-primary">Save</button>
                        </div>
                        <p id="save-preset-desc" class="text-xs text-gray-500">Saves the currently active settings as a new preset.</p>
                    </div>
                    <hr class="my-6" style="border-color: var(--border-color);">
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold">Load & Apply Presets</h4>
                        <select id="load-preset-select" class="input-cell w-full"></select>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="load-preset-btn" class="btn">Apply to This Sheet</button>
                             <button id="apply-preset-all-btn" class="btn">Apply to All Sheets</button>
                        </div>
                         <button id="delete-preset-btn" class="btn btn-danger w-full mt-2">Delete Selected Preset</button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
    // --- APP INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => App.init());

    // --- MAIN APP MODULE ---
    const App = (() => {
        // --- PRIVATE STATE & CONFIG ---
        let _state = {};
        const _history = { stack: [], index: -1, isNavigating: false };

        const STORAGE_KEY = 'campaignCalculatorProData_v5';
        const DEFAULT_ACOS_LOGIC = [
            { min: 0, max: 30, decrease: 0.00 }, { min: 31, max: 35, decrease: 0.08 },
            { min: 36, max: 40, decrease: 0.20 }, { min: 41, max: 45, decrease: 0.29 },
            { min: 46, max: 50, decrease: 0.37 }, { min: 51, max: 54, decrease: 0.44 },
            { min: 55, max: 59, decrease: 0.48 }, { min: 60, max: 69, decrease: 0.55 },
            { min: 70, max: 79, decrease: 0.60 }, { min: 80, max: 999, decrease: 0.65 }
        ];
        const DEFAULT_SETTINGS = {
            acosLogic: JSON.parse(JSON.stringify(DEFAULT_ACOS_LOGIC)),
            formattingRules: []
        };

        // --- PRIVATE MODULES ---
        const Util = {
            parseCurrency: (value) => {
                if (typeof value !== 'string' || value.trim() === '') return null;
                const num = parseFloat(String(value).replace(/[$,]/g, ''));
                return isNaN(num) ? null : num;
            },
            parsePercentage: (value) => {
                if (typeof value !== 'string' || value.trim() === '') return null;
                const num = parseFloat(String(value).replace(/[%]/g, ''));
                return isNaN(num) ? null : num;
            },
            formatCurrency: (value) => (value === null || isNaN(value)) ? '' : `$${value.toFixed(2)}`,
            formatPercentage: (value) => (value === null || isNaN(value)) ? '' : `${value}%`,
            isValidURL: (string) => { try { new URL(string); return true; } catch (_) { return false; } },
            createDefaultRowData: () => ({ 
                id: Date.now() + Math.random(), selected: false, name: '', link: '',
                tos_cpc: '', tos_acos: '', ros_cpc: '', ros_acos: '', pp_cpc: '', pp_acos: '', 
                highlight: 'none' 
            }),
            createDefaultSheet: (name) => ({
                id: Date.now() + Math.random(),
                name: name,
                title: name,
                link: '',
                data: Array(10).fill(null).map(Util.createDefaultRowData),
                useCustomSettings: false,
                settings: JSON.parse(JSON.stringify(DEFAULT_SETTINGS))
            }),
            getEl: (id) => document.getElementById(id),
        };

        const State = {
            load: () => {
                const savedState = localStorage.getItem(STORAGE_KEY);
                if (savedState) {
                    _state = JSON.parse(savedState);
                    // --- Data Migration & Validation ---
                    _state.theme = _state.theme || 'light';
                    _state.presets = _state.presets || {};
                    _state.defaultSettings = _state.defaultSettings || JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
                    _state.notes = _state.notes || '';
                    _state.sheets.forEach(sheet => {
                        sheet.id = sheet.id || Date.now() + Math.random();
                        sheet.title = sheet.title || sheet.name || `Untitled Sheet`;
                        sheet.link = sheet.link || '';
                        if (sheet.useCustomSettings === undefined) sheet.useCustomSettings = false;
                        sheet.settings = sheet.settings || JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
                        sheet.settings.formattingRules = sheet.settings.formattingRules || [];
                        sheet.data.forEach(row => { 
                            row.highlight = row.highlight || 'none'; 
                            row.link = row.link || '';
                        });
                    });
                } else {
                    _state = {
                        theme: 'light', activeMainTab: 'calculator', activeSheetIndex: 0, sheets: [],
                        presets: { "Default": JSON.parse(JSON.stringify(DEFAULT_SETTINGS)) },
                        defaultSettings: JSON.parse(JSON.stringify(DEFAULT_SETTINGS)),
                        notes: ''
                    };
                    _state.sheets.push(Util.createDefaultSheet('Sheet 1'));
                }
                State.recordHistory();
            },
            save: (record = true) => {
                if (record) State.recordHistory();
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(_state));
                } catch (e) {
                    console.error("Error saving state:", e);
                    UI.showToast("Error saving data.", 5000);
                }
            },
            recordHistory: () => {
                if (_history.isNavigating) return;
                _history.stack = _history.stack.slice(0, _history.index + 1);
                _history.stack.push(JSON.stringify(_state));
                _history.index++;
                UI.updateUndoRedoButtons();
            },
            undo: () => {
                if (_history.index > 0) {
                    _history.isNavigating = true;
                    _history.index--;
                    _state = JSON.parse(_history.stack[_history.index]);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(_state));
                    UI.renderAll();
                    _history.isNavigating = false;
                }
            },
            redo: () => {
                if (_history.index < _history.stack.length - 1) {
                    _history.isNavigating = true;
                    _history.index++;
                    _state = JSON.parse(_history.stack[_history.index]);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(_state));
                    UI.renderAll();
                    _history.isNavigating = false;
                }
            },
            getCurrentSheet: () => _state.sheets[_state.activeSheetIndex],
            getSettingsForSheet: (sheet) => sheet.useCustomSettings ? sheet.settings : _state.defaultSettings,
        };

        const Calc = {
            getCalculationsForRow: (rowData, settings) => {
                const acosLogic = settings.acosLogic;
                const getDecreasePercent = (acos) => {
                    if (acos === null || isNaN(acos)) return 0;
                    const rule = acosLogic.find(r => acos >= r.min && acos <= r.max);
                    return rule ? rule.decrease : (acosLogic[acosLogic.length - 1]?.decrease || 0.65);
                };

                const inputs = {
                    tos_cpc: Util.parseCurrency(rowData.tos_cpc), tos_acos_raw: rowData.tos_acos.trim() || '000',
                    ros_cpc: Util.parseCurrency(rowData.ros_cpc), ros_acos_raw: rowData.ros_acos,
                    pp_cpc: Util.parseCurrency(rowData.pp_cpc), pp_acos_raw: rowData.pp_acos,
                };
                
                const calculatePotentialBid = (cpc, acos_raw, primary_fallback_is_000, fallback_cpc_1, fallback_cpc_2) => {
                    if (cpc === null) return null;
                    if (acos_raw === '000') {
                        let calculatedBid;
                        if (inputs.tos_cpc !== null && !primary_fallback_is_000) {
                            calculatedBid = inputs.tos_cpc / 3;
                        } else if (fallback_cpc_1 !== null) {
                            calculatedBid = fallback_cpc_1 / 2;
                        } else if (fallback_cpc_2 !== null) {
                            calculatedBid = fallback_cpc_2 / 2;
                        } else {
                            return null;
                        }
                        return Math.min(cpc, calculatedBid);
                    }
                    const acos = Util.parsePercentage(acos_raw);
                    if (acos === null) return null;
                    return cpc * (1 - getDecreasePercent(acos));
                };
                
                const tosIs000 = inputs.tos_acos_raw === '000';

                const potentialBids = {
                    tos: calculatePotentialBid(inputs.tos_cpc, inputs.tos_acos_raw, false, inputs.ros_cpc, inputs.pp_cpc),
                    ros: calculatePotentialBid(inputs.ros_cpc, inputs.ros_acos_raw, tosIs000, inputs.pp_cpc, null),
                    pp: calculatePotentialBid(inputs.pp_cpc, inputs.pp_acos_raw, tosIs000, inputs.ros_cpc, null),
                };
                
                const validBids = Object.values(potentialBids).filter(b => b !== null && !isNaN(b));
                const newBid = validBids.length > 0 ? Math.min(...validBids) : null;

                const calculateAdjustment = (potentialBid, finalBid) => {
                    if (potentialBid === null || finalBid === null || finalBid <= 0) return null;
                    return ((potentialBid / finalBid) - 1) * 100;
                };
                
                return {
                    new_bid: newBid,
                    tos_adjust: inputs.tos_acos_raw === '000' ? 0 : calculateAdjustment(potentialBids.tos, newBid),
                    ros_adjust: inputs.ros_acos_raw === '000' ? 0 : calculateAdjustment(potentialBids.ros, newBid),
                    pp_adjust: inputs.pp_acos_raw === '000' ? 0 : calculateAdjustment(potentialBids.pp, newBid),
                };
            }
        };

        const UI = {
            renderAll: () => {
                UI.applyTheme();
                UI.renderMainView();
                UI.updateUndoRedoButtons();
            },
            applyTheme: () => {
                const isDark = _state.theme === 'dark';
                document.body.classList.toggle('dark', isDark);
                Util.getEl('theme-icon-sun').classList.toggle('hidden', isDark);
                Util.getEl('theme-icon-moon').classList.toggle('hidden', !isDark);
            },
            renderMainView: () => {
                const mainContent = Util.getEl('main-content');
                mainContent.innerHTML = '';
                const template = Util.getEl(`${_state.activeMainTab}-view-template`);
                if (template) {
                    mainContent.appendChild(template.content.cloneNode(true));
                    if (_state.activeMainTab === 'calculator') {
                        UI.renderSheetTabs();
                        UI.renderSheetContent();
                        Events.addCalculatorEventListeners();
                    } else if (_state.activeMainTab === 'settings') {
                        UI.renderSettings();
                        Events.addSettingsEventListeners();
                    } else if (_state.activeMainTab === 'instructions') {
                        Util.getEl('notes-textarea').value = _state.notes;
                        Events.addInstructionsEventListeners();
                    }
                }
                document.querySelectorAll('#main-tabs-container .sheet-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === _state.activeMainTab);
                });
            },
            renderSheetTabs: () => {
                const container = Util.getEl('sheet-tabs-container');
                container.innerHTML = '';
                _state.sheets.forEach((sheet, index) => {
                    const tab = document.createElement('div');
                    tab.className = `sheet-tab ${index === _state.activeSheetIndex ? 'active' : ''}`;
                    tab.dataset.index = index;
                    tab.innerHTML = `
                        <span>${sheet.name}</span>
                        ${sheet.useCustomSettings ? '<span title="This sheet uses custom settings">⚙️</span>' : ''}
                        <button class="delete-sheet-btn" data-index="${index}" title="Delete Sheet">&times;</button>
                    `;
                    container.appendChild(tab);
                });
                const addBtn = document.createElement('button');
                addBtn.textContent = '+';
                addBtn.className = 'sheet-tab add-sheet-btn';
                addBtn.title = 'Add new sheet';
                if (_state.sheets.length >= 10) addBtn.disabled = true;
                container.appendChild(addBtn);
            },
            renderSheetContent: () => {
                const currentSheet = State.getCurrentSheet();
                if (!currentSheet) return;
                
                Util.getEl('sheet-title-input').value = currentSheet.title;
                Util.getEl('sheet-link-input').value = currentSheet.link;
                const tableBody = Util.getEl('campaign-table-body');
                tableBody.innerHTML = '';
                currentSheet.data.forEach((rowData, index) => {
                    const rowEl = UI.createRowElement(rowData, index);
                    tableBody.appendChild(rowEl);
                });
                Util.getEl('select-all-checkbox').checked = false;
                UI.updateBulkActionButtons();
            },
            createRowElement: (rowData, rowIndex) => {
                const row = document.createElement('tr');
                row.dataset.rowIndex = rowIndex;
                
                const sheetSettings = State.getSettingsForSheet(State.getCurrentSheet());
                const calculations = Calc.getCalculationsForRow(rowData, sheetSettings);
                
                const formatAdjustment = (value) => {
                    if (value === null) return '';
                    const sign = value >= 0 ? '+' : '';
                    const colorClass = value >= 0 ? 'adjustment-up' : 'adjustment-down';
                    return `<span class="${colorClass}">${sign}${value.toFixed(0)}%</span>`;
                };

                row.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox" ${rowData.selected ? 'checked' : ''} aria-label="Select row ${rowIndex + 1}"></td>
                    <td>
                        <div class="campaign-name-cell-container">
                            <input type="text" class="input-cell campaign-name-input" placeholder="Campaign Name" data-col-key="name" value="${rowData.name || ''}">
                        </div>
                    </td>
                    <td class="col-tos"><input type="text" class="input-cell cpc-input" data-col-key="tos_cpc" placeholder="$0.00" value="${rowData.tos_cpc || ''}"></td>
                    <td class="col-tos"><input type="text" class="input-cell acos-input" data-col-key="tos_acos" placeholder="0%" value="${rowData.tos_acos || ''}"></td>
                    <td class="col-ros"><input type="text" class="input-cell cpc-input" data-col-key="ros_cpc" placeholder="$0.00" value="${rowData.ros_cpc || ''}"></td>
                    <td class="col-ros"><input type="text" class="input-cell acos-input" data-col-key="ros_acos" placeholder="0%" value="${rowData.ros_acos || ''}"></td>
                    <td class="col-pp"><input type="text" class="input-cell cpc-input" data-col-key="pp_cpc" placeholder="$0.00" value="${rowData.pp_cpc || ''}"></td>
                    <td class="col-pp"><input type="text" class="input-cell acos-input" data-col-key="pp_acos" placeholder="0%" value="${rowData.pp_acos || ''}"></td>
                    <td class="output-cell new-bid">${Util.formatCurrency(calculations.new_bid)}</td>
                    <td class="output-cell tos-adjust">${formatAdjustment(calculations.tos_adjust)}</td>
                    <td class="output-cell ros-adjust">${formatAdjustment(calculations.ros_adjust)}</td>
                    <td class="output-cell pp-adjust">${formatAdjustment(calculations.pp_adjust)}</td>
                    <td class="link-cell">
                        <div class="campaign-name-cell-container">
                            <input type="text" class="input-cell" placeholder="Link" data-col-key="link" value="${rowData.link || ''}">
                            <a class="link-icon" target="_blank" rel="noopener noreferrer" aria-label="Open link"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-4.5 0V6.75A2.25 2.25 0 0115.75 4.5h1.5m-3 0h3m-3 0a2.25 2.25 0 00-2.25 2.25v1.5m3 0a2.25 2.25 0 002.25-2.25v-1.5m-6 6.75h6.75" /></svg></a>
                        </div>
                    </td>
                `;
                UI.applyConditionalFormatting(row, rowData);
                return row;
            },
            updateRowCalculations: (rowEl) => {
                const rowIndex = parseInt(rowEl.dataset.rowIndex);
                const rowData = State.getCurrentSheet().data[rowIndex];
                const sheetSettings = State.getSettingsForSheet(State.getCurrentSheet());
                const calculations = Calc.getCalculationsForRow(rowData, sheetSettings);
                
                const formatAdjustment = (value) => {
                    if (value === null) return '';
                    const sign = value >= 0 ? '+' : '';
                    const colorClass = value >= 0 ? 'adjustment-up' : 'adjustment-down';
                    return `<span class="${colorClass}">${sign}${value.toFixed(0)}%</span>`;
                };

                rowEl.querySelector('.new-bid').textContent = Util.formatCurrency(calculations.new_bid);
                rowEl.querySelector('.tos-adjust').innerHTML = formatAdjustment(calculations.tos_adjust);
                rowEl.querySelector('.ros-adjust').innerHTML = formatAdjustment(calculations.ros_adjust);
                rowEl.querySelector('.pp-adjust').innerHTML = formatAdjustment(calculations.pp_adjust);
                
                UI.applyConditionalFormatting(rowEl, rowData);
            },
            applyConditionalFormatting: (rowEl, rowData) => {
                const sheetSettings = State.getSettingsForSheet(State.getCurrentSheet());
                const rules = sheetSettings.formattingRules || [];
                rowEl.style.backgroundColor = rowData.highlight && rowData.highlight !== 'none' ? `var(--highlight-${rowData.highlight})` : '';

                if (!rules.length) return;
                
                const calculations = Calc.getCalculationsForRow(rowData, sheetSettings);
                const calcRowData = { ...rowData, ...calculations };

                for (const rule of rules) {
                    const cellValue = calcRowData[rule.column];
                    if (cellValue === null || cellValue === undefined) continue;
                    const ruleValue = (typeof cellValue === 'number' && !isNaN(cellValue)) ? parseFloat(rule.value) : rule.value;
                    let match = false;
                    switch (rule.operator) {
                        case '>': match = cellValue > ruleValue; break;
                        case '<': match = cellValue < ruleValue; break;
                        case '=': match = cellValue == ruleValue; break;
                        case '!=': match = cellValue != ruleValue; break;
                        case 'contains': match = String(cellValue).toLowerCase().includes(String(ruleValue).toLowerCase()); break;
                        case 'does not contain': match = !String(cellValue).toLowerCase().includes(String(ruleValue).toLowerCase()); break;
                    }
                    if (match) {
                        rowEl.style.backgroundColor = rule.color;
                        break; 
                    }
                }
            },
            showToast: (message, duration = 3000) => {
                const toast = Util.getEl('toast-container');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), duration);
            },
            showConfirmationModal: (message, onConfirm) => {
                const modal = Util.getEl('confirmation-modal');
                modal.querySelector('#modal-message').textContent = message;
                const confirmBtn = modal.querySelector('#modal-confirm-btn');
                const cancelBtn = modal.querySelector('#modal-cancel-btn');
                
                const confirmHandler = () => { onConfirm(); hideModal(); };
                const hideModal = () => {
                    modal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', hideModal);
                };
                
                confirmBtn.addEventListener('click', confirmHandler, { once: true });
                cancelBtn.addEventListener('click', hideModal, { once: true });
                modal.classList.remove('hidden');
            },
            updateUndoRedoButtons: () => {
                Util.getEl('undo-btn').disabled = _history.index <= 0;
                Util.getEl('redo-btn').disabled = _history.index >= _history.stack.length - 1;
            },
            updateBulkActionButtons: () => {
                const container = Util.getEl('bulk-actions-container');
                if (!container) return;
                const selectedCount = State.getCurrentSheet().data.filter(r => r.selected).length;
                container.querySelector('#delete-selected-btn').disabled = selectedCount === 0;
                container.querySelector('#copy-selected-btn').disabled = selectedCount === 0;
                container.querySelector('#highlight-palette-container').classList.toggle('hidden', selectedCount === 0);
                const selectAll = Util.getEl('select-all-checkbox');
                if (selectAll) {
                    const totalRows = State.getCurrentSheet().data.length;
                    selectAll.checked = selectedCount > 0 && totalRows > 0 && selectedCount === totalRows;
                }
            },
            renderSettings: () => {
                const currentSheet = State.getCurrentSheet();
                Util.getEl('settings-sheet-name').textContent = currentSheet.name;

                const useCustomToggle = Util.getEl('use-custom-settings-toggle');
                useCustomToggle.checked = currentSheet.useCustomSettings;
                Util.getEl('custom-settings-editors').classList.toggle('hidden', !currentSheet.useCustomSettings);
                Util.getEl('using-global-settings-msg').classList.toggle('hidden', currentSheet.useCustomSettings);
                Util.getEl('global-settings-container').classList.toggle('disabled', currentSheet.useCustomSettings);
                
                UI.renderAcosLogicTable('global', _state.defaultSettings.acosLogic);
                UI.renderConditionalFormattingTable('global', _state.defaultSettings.formattingRules);
                
                if(currentSheet.useCustomSettings) {
                    UI.renderAcosLogicTable('sheet', currentSheet.settings.acosLogic);
                    UI.renderConditionalFormattingTable('sheet', currentSheet.settings.formattingRules);
                }
                
                UI.renderPresets();
            },
            renderAcosLogicTable: (prefix, rules) => {
                const container = Util.getEl(`${prefix}-acos-logic-table-container`);
                container.innerHTML = `<div class="grid grid-cols-4 gap-2 font-semibold mb-2 px-2"><span>Min %</span><span>Max %</span><span>Decr %</span><span></span></div>`;
                rules.forEach((rule, index) => {
                    const div = document.createElement('div');
                    div.className = 'grid grid-cols-4 gap-2 items-center mb-1';
                    div.innerHTML = `
                        <input type="number" value="${rule.min}" data-index="${index}" data-field="min" class="input-cell w-full acos-logic-input" data-prefix="${prefix}">
                        <input type="number" value="${rule.max}" data-index="${index}" data-field="max" class="input-cell w-full acos-logic-input" data-prefix="${prefix}">
                        <input type="number" step="1" value="${rule.decrease * 100}" data-index="${index}" data-field="decrease" class="input-cell w-full acos-logic-input" data-prefix="${prefix}">
                        <button data-index="${index}" data-prefix="${prefix}" class="btn btn-danger remove-logic-rule-btn p-2 leading-none" aria-label="Delete rule">X</button>
                    `;
                    container.appendChild(div);
                });
            },
            renderConditionalFormattingTable: (prefix, rules) => {
                const container = Util.getEl(`${prefix}-conditional-formatting-container`);
                container.innerHTML = `<div class="grid grid-cols-5 gap-2 font-semibold mb-2 px-2 text-xs"><span>Column</span><span>Op</span><span>Value</span><span>Color</span><span></span></div>`;
                rules.forEach((rule, index) => {
                    const div = document.createElement('div');
                    div.className = 'grid grid-cols-5 gap-2 items-center mb-1';
                    const columns = ['name', 'tos_cpc', 'tos_acos', 'ros_cpc', 'ros_acos', 'pp_cpc', 'pp_acos', 'new_bid', 'tos_adjust', 'ros_adjust', 'pp_adjust'];
                    const operators = ['>', '<', '=', '!=', 'contains', 'no-contain'];
                    div.innerHTML = `
                        <select data-index="${index}" data-field="column" class="input-cell w-full formatting-rule-input" data-prefix="${prefix}">${columns.map(c => `<option value="${c}" ${rule.column === c ? 'selected' : ''}>${c}</option>`).join('')}</select>
                        <select data-index="${index}" data-field="operator" class="input-cell w-full formatting-rule-input" data-prefix="${prefix}">${operators.map(o => `<option value="${o}" ${rule.operator === o ? 'selected' : ''}>${o}</option>`).join('')}</select>
                        <input type="text" value="${rule.value}" data-index="${index}" data-field="value" class="input-cell w-full formatting-rule-input" data-prefix="${prefix}">
                        <input type="color" value="${rule.color}" data-index="${index}" data-field="color" class="input-cell w-full p-1 formatting-rule-input" data-prefix="${prefix}">
                        <button data-index="${index}" data-prefix="${prefix}" class="btn btn-danger remove-formatting-rule-btn p-2 leading-none" aria-label="Delete rule">X</button>
                    `;
                    container.appendChild(div);
                });
            },
            renderPresets: () => {
                const select = Util.getEl('load-preset-select');
                select.innerHTML = Object.keys(_state.presets).map(p => `<option value="${p}">${p}</option>`).join('');
            },
        };

        const Events = {
            init: () => {
                Events.addGlobalEventListeners();
                UI.renderAll();
            },
            addGlobalEventListeners: () => {
                Util.getEl('undo-btn').addEventListener('click', State.undo);
                Util.getEl('redo-btn').addEventListener('click', State.redo);
                Util.getEl('save-btn').addEventListener('click', () => {
                    State.save(true);
                    const btn = Util.getEl('save-btn');
                    btn.textContent = 'Saved!';
                    setTimeout(() => { btn.textContent = 'Save'; }, 1500);
                });
                Util.getEl('theme-switcher').addEventListener('click', () => {
                    _state.theme = _state.theme === 'light' ? 'dark' : 'light';
                    UI.applyTheme();
                    State.save(false);
                });
                Util.getEl('main-tabs-container').addEventListener('click', Events.handleMainTabClick);
                document.addEventListener('keydown', e => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'z') { e.preventDefault(); State.undo(); }
                        else if (e.key === 'y' || (e.key === 'Z' && e.shiftKey)) { e.preventDefault(); State.redo(); }
                    }
                });
            },
            addCalculatorEventListeners: () => {
                const view = Util.getEl('calculator-view');
                view.querySelector('#sheet-tabs-container').addEventListener('click', Events.handleSheetTabClick);
                view.querySelector('#sheet-tabs-container').addEventListener('dblclick', Events.handleSheetTabDoubleClick);
                view.querySelector('#sheet-title-input').addEventListener('blur', Events.handleSheetTitleChange);
                view.querySelector('#sheet-link-input').addEventListener('change', Events.handleSheetLinkChange);
                view.querySelector('#add-row-btn').addEventListener('click', Events.handleAddRow);
                view.querySelector('#select-all-checkbox').addEventListener('change', Events.handleSelectAll);
                view.querySelector('#delete-selected-btn').addEventListener('click', Events.handleDeleteSelected);
                view.querySelector('#copy-selected-btn').addEventListener('click', Events.handleCopySelected);
                view.querySelector('#import-csv-btn').addEventListener('click', () => view.querySelector('#csv-file-input').click());
                view.querySelector('#csv-file-input').addEventListener('change', Events.handleCsvImport);
                view.querySelector('#export-csv-btn').addEventListener('click', Events.handleCsvExport);
                view.querySelector('#highlight-palette-container').addEventListener('click', Events.handleHighlightClick);
                
                const tableBody = view.querySelector('#campaign-table-body');
                tableBody.addEventListener('input', Events.handleTableInput);
                tableBody.addEventListener('focusin', (e) => e.target.matches('.input-cell') && Events.handleFocus(e.target));
                tableBody.addEventListener('focusout', (e) => e.target.matches('.input-cell') && Events.handleBlur(e));
                tableBody.addEventListener('keydown', Events.handleKeyNavigation);
                tableBody.addEventListener('change', (e) => {
                    if (e.target.matches('.row-checkbox')) {
                        const row = e.target.closest('tr');
                        const rowIndex = parseInt(row.dataset.rowIndex);
                        State.getCurrentSheet().data[rowIndex].selected = e.target.checked;
                        State.save(false);
                        UI.updateBulkActionButtons();
                    }
                });
                tableBody.addEventListener('click', (e) => {
                    const linkIcon = e.target.closest('.link-icon');
                    if (linkIcon) {
                        const url = linkIcon.closest('.campaign-name-cell-container').querySelector('input').value;
                        if(Util.isValidURL(url)) window.open(url, '_blank');
                    }
                });
            },
            addSettingsEventListeners: () => {
                const settingsView = Util.getEl('settings-view');
                settingsView.addEventListener('change', Events.handleSettingsChange);
                settingsView.addEventListener('click', Events.handleSettingsClick);
            },
            addInstructionsEventListeners: () => {
                Util.getEl('notes-textarea').addEventListener('input', (e) => {
                    _state.notes = e.target.value;
                    State.save(false);
                });
            },
            handleMainTabClick: (e) => {
                if (e.target.matches('.sheet-tab[data-tab]')) {
                    _state.activeMainTab = e.target.dataset.tab;
                    State.save(false);
                    UI.renderAll();
                }
            },
            handleSheetTabClick: (e) => {
                const tab = e.target.closest('.sheet-tab');
                const deleteBtn = e.target.closest('.delete-sheet-btn');

                if (deleteBtn) {
                    const index = parseInt(deleteBtn.dataset.index);
                    const sheetName = _state.sheets[index].name;
                    UI.showConfirmationModal(`Are you sure you want to delete the sheet "${sheetName}"?`, () => {
                        _state.sheets.splice(index, 1);
                        if (_state.sheets.length === 0) {
                            _state.sheets.push(Util.createDefaultSheet('Sheet 1'));
                        }
                        _state.activeSheetIndex = Math.min(_state.activeSheetIndex, _state.sheets.length - 1);
                        State.save();
                        UI.renderAll();
                    });
                } else if (tab && tab.dataset.index) {
                    _state.activeSheetIndex = parseInt(tab.dataset.index);
                    State.save(false);
                    UI.renderAll();
                } else if (tab && tab.matches('.add-sheet-btn')) {
                    if (_state.sheets.length < 10) {
                        const newSheetName = `Sheet ${_state.sheets.length + 1}`;
                        _state.sheets.push(Util.createDefaultSheet(newSheetName));
                        _state.activeSheetIndex = _state.sheets.length - 1;
                        State.save();
                        UI.renderAll();
                    }
                }
            },
            handleSheetTabDoubleClick: (e) => {
                const tab = e.target.closest('.sheet-tab[data-index]');
                if (tab) {
                    const originalName = State.getCurrentSheet().name;
                    const nameSpan = tab.querySelector('span');
                    nameSpan.innerHTML = `<input type="text" class="rename-input bg-transparent text-center w-24" value="${originalName}">`;
                    const input = tab.querySelector('input');
                    input.focus();
                    input.select();
                    const finishRename = () => {
                        const newName = input.value.trim();
                        if (newName) {
                            State.getCurrentSheet().name = newName;
                            State.getCurrentSheet().title = newName;
                            State.save();
                        }
                        UI.renderAll();
                    };
                    input.addEventListener('blur', finishRename, { once: true });
                    input.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') input.blur(); });
                }
            },
            handleSheetTitleChange: (e) => {
                const newName = e.target.value;
                State.getCurrentSheet().title = newName;
                State.getCurrentSheet().name = newName;
                State.save();
                UI.renderSheetTabs();
            },
            handleSheetLinkChange: (e) => {
                State.getCurrentSheet().link = e.target.value;
                State.save();
            },
            handleFocus: (input) => {
                document.querySelectorAll('.active-row').forEach(r => r.classList.remove('active-row'));
                input.closest('tr').classList.add('active-row');
                input.select();
            },
            handleTableInput: (e) => {
                if (!e.target.matches('.input-cell')) return;
                const row = e.target.closest('tr');
                const rowIndex = parseInt(row.dataset.rowIndex);
                const colKey = e.target.dataset.colKey;
                State.getCurrentSheet().data[rowIndex][colKey] = e.target.value;
                UI.updateRowCalculations(row);
                State.save(false);
            },
            handleBlur: (e) => {
                const input = e.target;
                const row = input.closest('tr');
                const rowIndex = parseInt(row.dataset.rowIndex);
                const colKey = input.dataset.colKey;
                let value = input.value;
                if (colKey.endsWith('_cpc')) {
                    value = Util.formatCurrency(Util.parseCurrency(value));
                } else if (colKey.endsWith('_acos') && value !== '000') {
                    value = Util.formatPercentage(Util.parsePercentage(value));
                }
                input.value = value;
                State.getCurrentSheet().data[rowIndex][colKey] = value;
                State.save(true);
                UI.updateRowCalculations(row);
                row.classList.remove('active-row');
            },
            handleKeyNavigation: (e) => {
                const key = e.key;
                if (!key.startsWith('Arrow') && key !== 'Enter') return;
                
                const allInputsInRow = Array.from(e.target.closest('tr').querySelectorAll('.input-cell'));
                const currentIndexInRow = allInputsInRow.indexOf(e.target);
                if (currentIndexInRow === -1) return;

                e.preventDefault();
                
                if (key === 'Enter') {
                    if (currentIndexInRow < allInputsInRow.length - 1) {
                        allInputsInRow[currentIndexInRow + 1].focus();
                    } else {
                        const nextRow = e.target.closest('tr').nextElementSibling;
                        if (nextRow) nextRow.querySelector('.input-cell')?.focus();
                    }
                } else if (key === 'ArrowDown') {
                    const currentColIndex = e.target.closest('td').cellIndex;
                    const nextRow = e.target.closest('tr').nextElementSibling;
                    if (nextRow) nextRow.cells[currentColIndex]?.querySelector('.input-cell')?.focus();
                } else if (key === 'ArrowUp') {
                    const currentColIndex = e.target.closest('td').cellIndex;
                    const prevRow = e.target.closest('tr').previousElementSibling;
                    if (prevRow) prevRow.cells[currentColIndex]?.querySelector('.input-cell')?.focus();
                } else if (key === 'ArrowLeft' && e.target.selectionStart === 0) {
                    if (currentIndexInRow > 0) allInputsInRow[currentIndexInRow - 1].focus();
                } else if (key === 'ArrowRight' && e.target.selectionStart === e.target.value.length) {
                    if (currentIndexInRow < allInputsInRow.length - 1) allInputsInRow[currentIndexInRow + 1].focus();
                }
            },
            handleCopyResults: (button) => { 
                const row = button.closest('tr');
                const newBid = row.querySelector('.new-bid').textContent;
                const tosAdjust = row.querySelector('.tos-adjust').textContent;
                const rosAdjust = row.querySelector('.ros-adjust').textContent;
                const ppAdjust = row.querySelector('.pp-adjust').textContent;
                const textToCopy = [newBid, tosAdjust, rosAdjust, ppAdjust].join('\t');
                navigator.clipboard.writeText(textToCopy).then(() => UI.showToast('Results copied!'));
            },
            handleSelectAll: (e) => {
                State.getCurrentSheet().data.forEach(r => r.selected = e.target.checked);
                document.querySelectorAll('#campaign-table-body .row-checkbox').forEach(cb => cb.checked = e.target.checked);
                State.save(false);
                UI.updateBulkActionButtons();
            },
            handleDeleteSelected: () => { 
                const selectedCount = State.getCurrentSheet().data.filter(r => r.selected).length;
                if (selectedCount === 0) return;
                UI.showConfirmationModal(`Are you sure you want to delete ${selectedCount} campaign(s)?`, () => {
                    State.getCurrentSheet().data = State.getCurrentSheet().data.filter(row => !row.selected);
                    State.save();
                    UI.renderAll();
                });
            },
            handleCopySelected: () => { 
                const data = State.getCurrentSheet().data;
                const copies = data.filter(r => r.selected).map(r => ({ ...r, id: Date.now() + Math.random(), selected: false }));
                if (copies.length === 0) return;
                
                const lastSelectedIndex = data.map((r, i) => r.selected ? i : -1).filter(i => i !== -1).pop();
                data.splice(lastSelectedIndex + 1, 0, ...copies);
                State.save();
                UI.renderAll();
            },
            handleAddRow: () => { 
                const data = State.getCurrentSheet().data;
                data.push(Util.createDefaultRowData());
                State.save();
                UI.renderSheetContent();
                setTimeout(() => {
                    const newRow = Util.getEl('campaign-table-body').lastElementChild;
                    if (newRow) {
                        newRow.querySelector('input').focus();
                        newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 0);
            },
            handleCsvImport: (event) => { 
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const rows = text.split(/[\r\n]+/).slice(1);
                    const importedData = rows.map(rowStr => {
                        const values = rowStr.split(',');
                        if (values.length < 7) return null;
                        return {
                            id: Date.now() + Math.random(), selected: false,
                            name: values[0] || '', tos_cpc: values[1] || '', tos_acos: values[2] || '',
                            ros_cpc: values[3] || '', ros_acos: values[4] || '', pp_cpc: values[5] || '', pp_acos: values[6] || '',
                            highlight: 'none'
                        };
                    }).filter(d => d && d.name);

                    if(importedData.length > 0) {
                        State.getCurrentSheet().data = importedData;
                        State.save();
                        UI.renderAll();
                        UI.showToast(`${importedData.length} rows imported successfully.`);
                    } else {
                        UI.showToast('Could not import data. Check CSV format.', 4000);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            },
            handleCsvExport: () => { 
                const headers = ['name', 'tos_cpc', 'tos_acos', 'ros_cpc', 'ros_acos', 'pp_cpc', 'pp_acos', 'new_bid', 'tos_adjust', 'ros_adjust', 'pp_adjust'];
                let csvContent = headers.join(',') + '\n';
                
                const dataToExport = State.getCurrentSheet().data.map(rowData => {
                    if (!rowData.name) return '';
                    const calculations = Calc.getCalculationsForRow(rowData, State.getSettingsForSheet(State.getCurrentSheet()));
                    const calcData = { ...rowData, ...calculations };
                    return headers.map(h => `"${(calcData[h] || '').toString().replace(/"/g, '""')}"`).join(',');
                }).filter(r => r).join('\n');

                csvContent += dataToExport;
                const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${State.getCurrentSheet().name}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                UI.showToast('Data exported.');
            },
            handleSettingsChange: (e) => { 
                const target = e.target;
                if (target.id === 'use-custom-settings-toggle') {
                    State.getCurrentSheet().useCustomSettings = target.checked;
                } else if (target.matches('.acos-logic-input, .formatting-rule-input')) {
                    const prefix = target.dataset.prefix;
                    const settingsObj = prefix === 'global' ? _state.defaultSettings : State.getCurrentSheet().settings;
                    const index = parseInt(target.dataset.index);
                    const field = target.dataset.field;
                    let value = target.value;
                    
                    if (target.matches('.acos-logic-input')) {
                        let numValue = parseFloat(value);
                        if (isNaN(numValue)) numValue = 0;
                        if (field === 'decrease') numValue /= 100;
                        settingsObj.acosLogic[index][field] = numValue;
                        settingsObj.acosLogic.sort((a, b) => a.min - b.min);
                    } else {
                        settingsObj.formattingRules[index][field] = value;
                    }
                }
                State.save();
                UI.renderAll();
            },
            handleSettingsClick: (e) => { 
                const target = e.target.closest('button');
                if (!target) return;

                const handleRuleChange = (prefix, type, action, index) => {
                    const settingsObj = prefix === 'global' ? _state.defaultSettings : State.getCurrentSheet().settings;
                    const rules = type === 'logic' ? settingsObj.acosLogic : settingsObj.formattingRules;
                    
                    if (action === 'add') {
                        if (type === 'logic') rules.push({ min: 100, max: 110, decrease: 0.70 });
                        else rules.push({ column: 'new_bid', operator: '>', value: '1.00', color: '#fecaca' });
                    } else if (action === 'remove') {
                        rules.splice(index, 1);
                    }
                };

                if (target.id.includes('logic-rule-btn')) {
                    const prefix = target.id.includes('global') ? 'global' : 'sheet';
                    const action = target.id.includes('add') ? 'add' : 'remove';
                    handleRuleChange(prefix, 'logic', action, parseInt(target.dataset.index));
                } else if (target.id.includes('formatting-rule-btn')) {
                    const prefix = target.id.includes('global') ? 'global' : 'sheet';
                    const action = target.id.includes('add') ? 'add' : 'remove';
                    handleRuleChange(prefix, 'formatting', action, parseInt(target.dataset.index));
                } else if (target.id === 'save-preset-btn') {
                    const name = Util.getEl('preset-name-input').value.trim();
                    if (name) {
                        const settingsToSave = State.getSettingsForSheet(State.getCurrentSheet());
                        _state.presets[name] = JSON.parse(JSON.stringify(settingsToSave));
                        Util.getEl('preset-name-input').value = '';
                        UI.showToast(`Preset "${name}" saved.`);
                    }
                } else if (target.id === 'load-preset-btn') {
                    const name = Util.getEl('load-preset-select').value;
                    if (name && _state.presets[name]) {
                        const sheet = State.getCurrentSheet();
                        sheet.settings = JSON.parse(JSON.stringify(_state.presets[name]));
                        sheet.useCustomSettings = true; // Loading a preset implies custom settings
                        UI.showToast(`Preset "${name}" applied to this sheet.`);
                    }
                } else if (target.id === 'apply-preset-all-btn') {
                     const name = Util.getEl('load-preset-select').value;
                    if (name && _state.presets[name]) {
                        UI.showConfirmationModal(`Apply "${name}" preset to all sheets?`, () => {
                            _state.sheets.forEach(sheet => {
                                sheet.settings = JSON.parse(JSON.stringify(_state.presets[name]));
                                sheet.useCustomSettings = true;
                            });
                            UI.showToast(`Preset applied to all sheets.`);
                            State.save();
                            UI.renderAll();
                        });
                    }
                } else if (target.id === 'delete-preset-btn') {
                    const name = Util.getEl('load-preset-select').value;
                    if (name && name !== "Default") {
                        UI.showConfirmationModal(`Are you sure you want to delete the "${name}" preset?`, () => {
                            delete _state.presets[name];
                            UI.showToast(`Preset "${name}" deleted.`);
                            State.save();
                            UI.renderSettings();
                        });
                    } else if (name === "Default") {
                        UI.showToast("Cannot delete the Default preset.", 4000);
                    }
                }
                State.save();
                UI.renderAll();
            },
            handleHighlightClick: (e) => {
                if (e.target.matches('.color-swatch')) {
                    const color = e.target.dataset.color;
                    State.getCurrentSheet().data.forEach((row, index) => {
                        if (row.selected) {
                            row.highlight = color;
                            const rowEl = document.querySelector(`tr[data-row-index="${index}"]`);
                            if (rowEl) rowEl.style.backgroundColor = color !== 'none' ? `var(--highlight-${color})` : '';
                        }
                    });
                    State.save();
                }
            },
        };
        
        // --- PUBLIC API ---
        return {
            init: () => {
                State.load();
                Events.init();
            }
        };
    })();
    </script>
</body>
</html>
