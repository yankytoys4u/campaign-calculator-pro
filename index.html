<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Calculator Pro v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8fafc; --bg-secondary: #fff; --bg-tertiary: #f1f5f9;
            --text-primary: #111827; --text-secondary: #475569; --border-color: #e2e8f0;
            --highlight-yellow: #fde047; --highlight-green: #86efac; --highlight-red: #fca5a5;
            --highlight-blue: #93c5fd; --highlight-purple: #d8b4fe;
            --brand-color: #4f46e5;
        }
        .dark {
            --bg-primary: #111827; --bg-secondary: #1f2937; --bg-tertiary: #374151;
            --text-primary: #f9fafb; --text-secondary: #9ca3af; --border-color: #4b5563;
            --highlight-yellow: #a16207; --highlight-green: #16a34a; --highlight-red: #dc2626;
            --highlight-blue: #2563eb; --highlight-purple: #9333ea;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        .main-container { width: 95%; max-width: 2400px; margin: auto; background-color: var(--bg-secondary); }
        .hidden { display: none !important; }
        .tab-content { border: 1px solid var(--border-color); border-top: none; padding: 1.5rem; background-color: var(--bg-secondary); border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        .sheet-title { font-size: 1.875rem; font-weight: 700; border: 2px solid transparent; border-radius: 0.5rem; padding: 0.25rem 0.5rem; margin-bottom: 1rem; width: 100%; background-color: transparent; color: var(--text-primary); }
        .sheet-title:hover { border-color: var(--border-color); }
        .sheet-title:focus { border-color: var(--brand-color); outline: none; background-color: var(--bg-tertiary); }
        .table-container { overflow-x: auto; }
        th { position: sticky; top: 0; z-index: 10; background-color: var(--bg-tertiary); }
        td, th { padding: 8px; border: 1px solid var(--border-color); text-align: center; white-space: nowrap; position: relative; }
        .input-cell { width: 100px; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); text-align: center; background-color: var(--bg-secondary); color: var(--text-primary); transition: all 0.2s; }
        .input-cell:focus { outline: none; border-color: var(--brand-color); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        .campaign-name-input { width: 450px; }
        .link-icon { color: var(--brand-color); cursor: pointer; display: none; }
        .output-cell { font-weight: 600; color: #312e81; background-color: #eef2ff; }
        .dark .output-cell { background-color: #3730a3; color: #e0e7ff; }
        .header-tos { background-color: #bae6fd; color: #0c4a6e;} .col-tos { background-color: #f0f9ff; }
        .header-ros { background-color: #bbf7d0; color: #14532d;} .col-ros { background-color: #f0fdf4; }
        .header-pp { background-color: #fde68a; color: #78350f;} .col-pp { background-color: #fefce8; }
        .dark .col-tos { background-color: #0c4a6e; } .dark .col-ros { background-color: #14532d; } .dark .col-pp { background-color: #78350f; }
        .adjustment-up { color: #15803d; } .adjustment-down { color: #b91c1c; }
        .dark .adjustment-up { color: #4ade80; } .dark .adjustment-down { color: #f87171; }
        .sheet-tabs { display: flex; border-bottom: 2px solid var(--border-color); flex-wrap: wrap; }
        .sheet-tab { padding: 10px 16px; cursor: pointer; border: 1px solid transparent; border-bottom: none; margin-bottom: -2px; color: var(--text-secondary); font-weight: 500; }
        .sheet-tab.active { color: var(--brand-color); border-color: var(--border-color) var(--border-color) var(--bg-secondary); border-top-left-radius: 8px; border-top-right-radius: 8px; background-color: var(--bg-secondary); }
        .sheet-tab:not(.active):hover { background-color: var(--bg-tertiary); border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .btn { background-color: var(--bg-secondary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; font-weight: 600; color: var(--text-primary); transition: all 0.2s; cursor: pointer; }
        .btn:hover:not(:disabled) { background-color: var(--bg-tertiary); border-color: #9ca3af; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--brand-color); color: white; border-color: var(--brand-color); }
        .btn-danger { background-color: #ef4444; color: white; border-color: #ef4444; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--toast-bg); color: var(--toast-text); padding: 12px 20px; border-radius: 8px; z-index: 1000; opacity: 0; transition: opacity 0.3s, bottom 0.3s; font-weight: 500; }
        .toast.show { opacity: 1; bottom: 30px; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .modal-box { background-color: var(--bg-secondary); padding: 2rem; border-radius: 0.5rem; max-width: 500px; width: 90%; text-align: center; }
        .active-row { background-color: var(--highlight-yellow) !important; opacity: 0.7; }
        .highlight-palette { display: flex; gap: 0.5rem; align-items: center; }
        .color-swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid var(--border-color); }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">

    <div class="main-container rounded-2xl shadow-lg">
        <div class="p-6">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold">Campaign Calculator</h1>
                <div class="flex items-center gap-4">
                    <button id="undo-btn" class="btn p-2" title="Undo (Ctrl+Z)" disabled>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    </button>
                    <button id="redo-btn" class="btn p-2" title="Redo (Ctrl+Y)" disabled>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>
                    <button id="save-btn" class="btn" title="Save Progress">Save</button>
                    <div id="theme-switcher" class="flex items-center cursor-pointer" title="Toggle Theme">
                        <svg id="theme-icon-sun" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-15.66l-.7.7M4.04 19.96l-.7.7M21 12h-1M4 12H3m15.66 8.66l-.7-.7M4.04 4.04l-.7-.7M12 18a6 6 0 100-12 6 6 0 000 12z"></path></svg>
                        <svg id="theme-icon-moon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </div>
                </div>
            </div>

            <!-- Main Tabs -->
            <div id="main-tabs-container" class="sheet-tabs">
                <div class="sheet-tab active" data-tab="calculator">Calculator</div>
                <div class="sheet-tab" data-tab="instructions">Instructions</div>
                <div class="sheet-tab" data-tab="settings">Settings</div>
            </div>

            <!-- Main Content Area -->
            <div id="main-content">
                <!-- Views are dynamically inserted here from templates -->
            </div>
        </div>
    </div>
    
    <!-- Toast & Modal Templates -->
    <div id="toast-container" class="toast"></div>
    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Are you sure?</h3>
            <p id="modal-message" class="mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="modal-cancel-btn" class="btn">Cancel</button>
                <button id="modal-confirm-btn" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <!-- View Templates -->
    <template id="calculator-view-template">
        <div id="calculator-view" class="tab-content">
            <div id="sheet-tabs-container" class="sheet-tabs"></div>
            <div id="sheet-content">
                <input type="text" id="sheet-title-input" class="sheet-title" value="Sheet Title">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <div id="bulk-actions-container" class="flex gap-4 items-center">
                        <button id="delete-selected-btn" class="btn" disabled>Delete</button>
                        <button id="copy-selected-btn" class="btn" disabled>Copy</button>
                        <div id="highlight-palette-container" class="highlight-palette hidden">
                            <div class="color-swatch" style="background-color: var(--highlight-green);" data-color="green"></div>
                            <div class="color-swatch" style="background-color: var(--highlight-red);" data-color="red"></div>
                            <div class="color-swatch" style="background-color: var(--highlight-blue);" data-color="blue"></div>
                            <div class="color-swatch" style="background-color: var(--highlight-yellow);" data-color="yellow"></div>
                            <div class="color-swatch" style="background-color: var(--highlight-purple);" data-color="purple"></div>
                            <div class="color-swatch" style="background-color: transparent; border: 2px dashed var(--text-secondary);" data-color="none" title="Clear Highlight"></div>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button id="import-csv-btn" class="btn">Import CSV</button>
                        <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                        <button id="export-csv-btn" class="btn">Export CSV</button>
                    </div>
                </div>
                <div class="table-container rounded-lg border border-gray-300">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th class="w-12"><input type="checkbox" id="select-all-checkbox"></th>
                                <th class="bg-slate-100">Campaign Name</th>
                                <th class="header-tos">TOS CPC</th><th class="header-tos">TOS ACOS %</th>
                                <th class="header-ros">ROS CPC</th><th class="header-ros">ROS ACOS %</th>
                                <th class="header-pp">PP CPC</th><th class="header-pp">PP ACOS %</th>
                                <th class="header-output">New Bid</th><th class="header-output">TOS Adjust</th>
                                <th class="header-output">ROS Adjust</th><th class="header-output">PP Adjust</th>
                                <th class="bg-slate-100">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="campaign-table-body"></tbody>
                    </table>
                </div>
                <div class="mt-6 flex justify-center">
                    <button id="add-row-btn" class="btn btn-primary">Add Campaign</button>
                </div>
            </div>
        </div>
    </template>
    
    <template id="instructions-view-template">
        <div id="instructions-view" class="tab-content prose dark:prose-invert lg:prose-xl max-w-none">
            <h2>Welcome to Campaign Calculator Pro v3!</h2>
            <p>This tool is designed to streamline your campaign bid adjustments. Hereâ€™s how to use its powerful features:</p>
            <h3>Core Functionality</h3>
            <ul>
                <li><strong>Data Entry:</strong> Fill in the CPC and ACOS % for each placement. The <strong>New Bid</strong> and adjustments are calculated instantly.</li>
                <li><strong>Undo/Redo:</strong> Use the Undo/Redo buttons or Ctrl+Z/Ctrl+Y to reverse your actions.</li>
                <li><strong>Save:</strong> While the app auto-saves, you can click the "Save" button for peace of mind.</li>
                <li><strong>Dark/Light Mode:</strong> Use the sun/moon icon to toggle the theme.</li>
                <li><strong>Manual Highlighting:</strong> Select rows with the checkbox, then choose a color from the palette that appears.</li>
            </ul>
            <h3>Sheet Management</h3>
            <ul>
                <li><strong>Multiple Sheets:</strong> You can work with up to 5 separate sheets. Click a tab to switch, or click the <strong>+</strong> button to add more (up to 10).</li>
                <li><strong>Rename Sheets:</strong> Double-click any sheet tab to rename it.</li>
                <li><strong>Sheet Titles:</strong> Each sheet has its own main title above the table. Simply click the title to edit it.</li>
            </ul>
        </div>
    </template>

    <template id="settings-view-template">
        <div id="settings-view" class="tab-content">
            <h2 class="text-2xl font-bold mb-4">Settings for <span id="settings-sheet-name" class="text-indigo-600"></span></h2>
            <div class="settings-grid">
                <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3">ACOS Logic Table</h3>
                    <div id="acos-logic-table-container"></div>
                    <button id="add-logic-rule-btn" class="btn mt-3 w-full">Add Rule</button>
                </div>
                <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3">Conditional Formatting</h3>
                     <div id="conditional-formatting-container"></div>
                    <button id="add-formatting-rule-btn" class="btn mt-3 w-full">Add Rule</button>
                </div>
                <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3">Settings Presets</h3>
                    <div class="flex gap-2">
                        <input type="text" id="preset-name-input" placeholder="New Preset Name" class="input-cell flex-grow">
                        <button id="save-preset-btn" class="btn btn-primary">Save</button>
                    </div>
                    <div class="mt-4">
                        <label class="font-medium">Load Preset:</label>
                        <div class="flex gap-2 mt-1">
                            <select id="load-preset-select" class="input-cell flex-grow"></select>
                            <button id="load-preset-btn" class="btn">Load</button>
                            <button id="delete-preset-btn" class="btn btn-danger">Delete</button>
                        </div>
                    </div>
                     <div class="mt-4">
                        <button id="apply-preset-all-btn" class="btn w-full">Apply Current Settings to All Sheets</button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
    (() => {
        document.addEventListener('DOMContentLoaded', function() {
            // --- STATE MANAGEMENT ---
            const STORAGE_KEY = 'campaignCalculatorProData_v3';
            let state = {};
            let history = []; // For undo/redo
            let historyIndex = -1;

            const DEFAULT_ACOS_LOGIC = [
                { min: 0, max: 30, decrease: 0.00 }, { min: 31, max: 35, decrease: 0.08 },
                { min: 36, max: 40, decrease: 0.20 }, { min: 41, max: 45, decrease: 0.29 },
                { min: 46, max: 50, decrease: 0.37 }, { min: 51, max: 54, decrease: 0.44 },
                { min: 55, max: 59, decrease: 0.48 }, { min: 60, max: 69, decrease: 0.55 },
                { min: 70, max: 79, decrease: 0.60 }, { min: 80, max: 999, decrease: 0.65 }
            ];

            // --- UTILITY FUNCTIONS ---
            const parseCurrency = (value) => parseFloat(String(value).replace(/[$,]/g, '')) || null;
            const parsePercentage = (value) => parseFloat(String(value).replace(/[%]/g, '')) || null;
            
            function showToast(message, duration = 3000) {
                const toast = document.getElementById('toast-container');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), duration);
            }

            function showConfirmationModal(message, onConfirm) {
                const modal = document.getElementById('confirmation-modal');
                modal.querySelector('#modal-message').textContent = message;
                const confirmBtn = modal.querySelector('#modal-confirm-btn');
                const cancelBtn = modal.querySelector('#modal-cancel-btn');
                
                const confirmHandler = () => { onConfirm(); hideModal(); };
                const hideModal = () => {
                    modal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', hideModal);
                };
                
                confirmBtn.addEventListener('click', confirmHandler, { once: true });
                cancelBtn.addEventListener('click', hideModal, { once: true });
                modal.classList.remove('hidden');
            }

            function isValidURL(string) {
                try { new URL(string); return true; } catch (_) { return false; }
            }
            
            function createDefaultRowData() {
                return { id: Date.now() + Math.random(), name: '', tos_cpc: '', tos_acos: '', ros_cpc: '', ros_acos: '', pp_cpc: '', pp_acos: '', highlight: 'none' };
            }

            // --- HISTORY (UNDO/REDO) MANAGEMENT ---
            function recordHistory(sourceState) {
                history = history.slice(0, historyIndex + 1);
                history.push(JSON.parse(JSON.stringify(sourceState)));
                historyIndex++;
                updateUndoRedoButtons();
            }

            function undo() {
                if (historyIndex > 0) {
                    historyIndex--;
                    state = JSON.parse(JSON.stringify(history[historyIndex]));
                    renderAll();
                    updateUndoRedoButtons();
                }
            }

            function redo() {
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    state = JSON.parse(JSON.stringify(history[historyIndex]));
                    renderAll();
                    updateUndoRedoButtons();
                }
            }

            function updateUndoRedoButtons() {
                document.getElementById('undo-btn').disabled = historyIndex <= 0;
                document.getElementById('redo-btn').disabled = historyIndex >= history.length - 1;
            }

            // --- STATE PERSISTENCE ---
            function saveState(record = true) {
                if (record) recordHistory(state);
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                } catch (e) {
                    console.error("Error saving state:", e);
                    showToast("Error saving data.", 5000);
                }
            }

            function loadState() {
                const savedState = localStorage.getItem(STORAGE_KEY);
                if (savedState) {
                    state = JSON.parse(savedState);
                    // Compatibility checks for new features
                    if (!state.theme) state.theme = 'light';
                    if (!state.presets) state.presets = {};
                    state.sheets.forEach(sheet => {
                        if (!sheet.title) sheet.title = `Untitled Sheet`;
                        if (!sheet.settings) sheet.settings = { acosLogic: JSON.parse(JSON.stringify(DEFAULT_ACOS_LOGIC)), formattingRules: [] };
                        sheet.data.forEach(row => { if (!row.highlight) row.highlight = 'none'; });
                    });
                } else {
                    state = {
                        theme: 'light', activeMainTab: 'calculator', activeSheetIndex: 0, sheets: [],
                        presets: { "Default": { acosLogic: JSON.parse(JSON.stringify(DEFAULT_ACOS_LOGIC)), formattingRules: [] } }
                    };
                    for (let i = 1; i <= 5; i++) {
                        state.sheets.push({
                            name: `Sheet ${i}`, title: `Campaign Group ${i}`,
                            data: Array(10).fill({}).map(() => createDefaultRowData()),
                            settings: { acosLogic: JSON.parse(JSON.stringify(DEFAULT_ACOS_LOGIC)), formattingRules: [] }
                        });
                    }
                }
                recordHistory(state); // Initial state for undo
            }

            // --- THEME MANAGEMENT ---
            function applyTheme() {
                const body = document.body;
                const sunIcon = document.getElementById('theme-icon-sun');
                const moonIcon = document.getElementById('theme-icon-moon');
                if (state.theme === 'dark') {
                    body.classList.add('dark');
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                } else {
                    body.classList.remove('dark');
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                }
            }

            function toggleTheme() {
                state.theme = state.theme === 'light' ? 'dark' : 'light';
                applyTheme();
                saveState(); // Record theme change in history
            }
            
            // --- RENDER FUNCTIONS ---
            function renderAll() {
                applyTheme();
                renderMainView();
                updateUndoRedoButtons();
            }

            function renderMainView() {
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = ''; // Clear previous view
                const templateId = `${state.activeMainTab}-view-template`;
                const template = document.getElementById(templateId);
                if (template) {
                    mainContent.appendChild(template.content.cloneNode(true));
                    if (state.activeMainTab === 'calculator') {
                        renderSheetTabs();
                        renderSheetContent();
                        addCalculatorEventListeners();
                    } else if (state.activeMainTab === 'settings') {
                        renderSettings();
                        addSettingsEventListeners();
                    }
                }
                document.querySelectorAll('#main-tabs-container .sheet-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === state.activeMainTab);
                });
            }

            function renderSheetTabs() {
                const container = document.getElementById('sheet-tabs-container');
                container.innerHTML = '';
                state.sheets.forEach((sheet, index) => {
                    const tab = document.createElement('div');
                    tab.className = 'sheet-tab';
                    tab.classList.toggle('active', index === state.activeSheetIndex);
                    tab.textContent = sheet.name;
                    tab.dataset.index = index;
                    container.appendChild(tab);
                });
                const addBtn = document.createElement('button');
                addBtn.textContent = '+';
                addBtn.className = 'sheet-tab add-sheet-btn';
                addBtn.title = 'Add new sheet';
                if (state.sheets.length >= 10) addBtn.disabled = true;
                container.appendChild(addBtn);
            }
            
            function renderSheetContent() {
                const currentSheet = state.sheets[state.activeSheetIndex];
                if (!currentSheet) return;
                
                document.getElementById('sheet-title-input').value = currentSheet.title;
                const tableBody = document.getElementById('campaign-table-body');
                tableBody.innerHTML = '';
                currentSheet.data.forEach((rowData, index) => {
                    const row = createRowElement(rowData, index);
                    tableBody.appendChild(row);
                });
                document.getElementById('select-all-checkbox').checked = false;
                updateBulkActionButtons();
            }

            function renderSettings() {
                const currentSheet = state.sheets[state.activeSheetIndex];
                document.getElementById('settings-sheet-name').textContent = currentSheet.name;
                renderAcosLogicTable();
                renderConditionalFormattingTable();
                renderPresets();
            }
            
            function renderAcosLogicTable() {
                const container = document.getElementById('acos-logic-table-container');
                container.innerHTML = `<div class="grid grid-cols-4 gap-2 font-semibold mb-2 px-2">
                    <span>Min ACOS %</span><span>Max ACOS %</span><span>Decrease %</span><span></span></div>`;
                const logicTable = state.sheets[state.activeSheetIndex].settings.acosLogic;
                logicTable.forEach((rule, index) => {
                    const div = document.createElement('div');
                    div.className = 'grid grid-cols-4 gap-2 items-center mb-1';
                    div.innerHTML = `
                        <input type="number" value="${rule.min}" data-index="${index}" data-field="min" class="input-cell w-full acos-logic-input">
                        <input type="number" value="${rule.max}" data-index="${index}" data-field="max" class="input-cell w-full acos-logic-input">
                        <input type="number" step="0.01" value="${rule.decrease * 100}" data-index="${index}" data-field="decrease" class="input-cell w-full acos-logic-input">
                        <button data-index="${index}" class="btn btn-danger remove-logic-rule-btn p-2 leading-none">X</button>
                    `;
                    container.appendChild(div);
                });
            }

            function renderConditionalFormattingTable() {
                 const container = document.getElementById('conditional-formatting-container');
                container.innerHTML = `<div class="grid grid-cols-5 gap-2 font-semibold mb-2 px-2">
                    <span>Column</span><span>Operator</span><span>Value</span><span>Color</span><span></span></div>`;
                const rules = state.sheets[state.activeSheetIndex].settings.formattingRules;
                rules.forEach((rule, index) => {
                    const div = document.createElement('div');
                    div.className = 'grid grid-cols-5 gap-2 items-center mb-1';
                    const columns = ['name', 'tos_cpc', 'tos_acos', 'ros_cpc', 'ros_acos', 'pp_cpc', 'pp_acos', 'new_bid', 'tos_adjust', 'ros_adjust', 'pp_adjust'];
                    const operators = ['>', '<', '=', '!=', 'contains', 'does not contain'];
                    div.innerHTML = `
                        <select data-index="${index}" data-field="column" class="input-cell w-full formatting-rule-input">${columns.map(c => `<option value="${c}" ${rule.column === c ? 'selected' : ''}>${c}</option>`).join('')}</select>
                        <select data-index="${index}" data-field="operator" class="input-cell w-full formatting-rule-input">${operators.map(o => `<option value="${o}" ${rule.operator === o ? 'selected' : ''}>${o}</option>`).join('')}</select>
                        <input type="text" value="${rule.value}" data-index="${index}" data-field="value" class="input-cell w-full formatting-rule-input">
                        <input type="color" value="${rule.color}" data-index="${index}" data-field="color" class="input-cell w-full p-1 formatting-rule-input">
                        <button data-index="${index}" class="btn btn-danger remove-formatting-rule-btn p-2 leading-none">X</button>
                    `;
                    container.appendChild(div);
                });
            }

            function renderPresets() {
                const select = document.getElementById('load-preset-select');
                select.innerHTML = Object.keys(state.presets).map(p => `<option value="${p}">${p}</option>`).join('');
            }
            
            function updateBulkActionButtons() {
                const container = document.getElementById('bulk-actions-container');
                if (!container) return;
                const tableBody = document.getElementById('campaign-table-body');
                const selectedCount = tableBody.querySelectorAll('.row-checkbox:checked').length;
                container.querySelector('#delete-selected-btn').disabled = selectedCount === 0;
                container.querySelector('#copy-selected-btn').disabled = selectedCount === 0;
                container.querySelector('#highlight-palette-container').classList.toggle('hidden', selectedCount === 0);
                const selectAll = document.getElementById('select-all-checkbox');
                if (selectAll) {
                    const totalRows = tableBody.querySelectorAll('.row-checkbox').length;
                    selectAll.checked = selectedCount > 0 && totalRows > 0 && selectedCount === totalRows;
                }
            }

            // --- ROW ELEMENT & LOGIC ---
            function createRowElement(data, rowIndex) {
                const row = document.createElement('tr');
                row.dataset.rowIndex = rowIndex;
                if (data.highlight && data.highlight !== 'none') {
                    row.style.backgroundColor = `var(--highlight-${data.highlight})`;
                }
                row.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox"></td>
                    <td>
                        <div class="campaign-name-cell-container">
                            <input type="text" class="input-cell campaign-name-input" placeholder="Campaign Name or URL" value="${data.name || ''}">
                            <a class="link-icon" target="_blank" rel="noopener noreferrer">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-4.5 0V6.75A2.25 2.25 0 0115.75 4.5h1.5m-3 0h3m-3 0a2.25 2.25 0 00-2.25 2.25v1.5m3 0a2.25 2.25 0 002.25-2.25v-1.5m-6 6.75h6.75" /></svg>
                            </a>
                        </div>
                    </td>
                    <td class="col-tos"><input type="text" class="input-cell cpc-input tos-cpc" placeholder="$0.00" value="${data.tos_cpc || ''}"></td>
                    <td class="col-tos"><input type="text" class="input-cell acos-input tos-acos" placeholder="0%" value="${data.tos_acos || ''}"></td>
                    <td class="col-ros"><input type="text" class="input-cell cpc-input ros-cpc" placeholder="$0.00" value="${data.ros_cpc || ''}"></td>
                    <td class="col-ros"><input type="text" class="input-cell acos-input ros-acos" placeholder="0%" value="${data.ros_acos || ''}"></td>
                    <td class="col-pp"><input type="text" class="input-cell cpc-input pp-cpc" placeholder="$0.00" value="${data.pp_cpc || ''}"></td>
                    <td class="col-pp"><input type="text" class="input-cell acos-input pp-acos" placeholder="0%" value="${data.pp_acos || ''}"></td>
                    <td class="output-cell new-bid"></td>
                    <td class="output-cell tos-adjust"></td>
                    <td class="output-cell ros-adjust"></td>
                    <td class="output-cell pp-adjust"></td>
                    <td>
                        <button class="action-btn copy-results-btn" title="Copy Results">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" /></svg>
                        </button>
                    </td>
                `;
                attachRowEventListeners(row, rowIndex);
                calculateAndFormatRow(row);
                return row;
            }

            function attachRowEventListeners(row, rowIndex) {
                const inputs = row.querySelectorAll('input.input-cell');
                inputs.forEach(input => {
                    input.addEventListener('input', (e) => handleInput(e, rowIndex));
                    input.addEventListener('focus', (e) => handleFocus(e.target));
                    input.addEventListener('blur', (e) => handleBlur(e, rowIndex));
                    input.addEventListener('keydown', handleKeyNavigation);
                });
                row.querySelector('.row-checkbox').addEventListener('change', updateBulkActionButtons);
                row.querySelector('.copy-results-btn').addEventListener('click', (e) => handleCopyResults(e.currentTarget));
                handleCampaignLink(row.querySelector('.campaign-name-input'));
            }

            function calculateAndFormatRow(row) {
                calculateRow(row);
                applyConditionalFormatting(row);
            }

            function calculateRow(row) {
                const acosLogicTable = state.sheets[state.activeSheetIndex].settings.acosLogic;
                const getDecreasePercent = (acos) => {
                    if (acos === null || isNaN(acos)) return 0;
                    const rule = acosLogicTable.find(r => acos >= r.min && acos <= r.max);
                    return rule ? rule.decrease : (acosLogicTable[acosLogicTable.length - 1]?.decrease || 0.65);
                };
                const inputs = {
                    tos_cpc: parseCurrency(row.querySelector('.tos-cpc').value), tos_acos_raw: row.querySelector('.tos-acos').value,
                    ros_cpc: parseCurrency(row.querySelector('.ros-cpc').value), ros_acos_raw: row.querySelector('.ros-acos').value,
                    pp_cpc: parseCurrency(row.querySelector('.pp-cpc').value), pp_acos_raw: row.querySelector('.pp-acos').value,
                };
                const outputs = {
                    new_bid: row.querySelector('.new-bid'), tos_adjust: row.querySelector('.tos-adjust'),
                    ros_adjust: row.querySelector('.ros-adjust'), pp_adjust: row.querySelector('.pp-adjust'),
                };
                const calculatePotentialBid = (cpc, acos_raw, primary_cpc, secondary_cpc) => {
                    if (cpc === null || acos_raw === '') return null;
                    if (acos_raw === '000') {
                        if (primary_cpc) return primary_cpc / 3;
                        if (secondary_cpc) return secondary_cpc / 2;
                        return null;
                    }
                    const acos = parsePercentage(acos_raw);
                    if (isNaN(acos) || acos === null) return null;
                    return cpc * (1 - getDecreasePercent(acos));
                };
                const potentialBids = {
                    tos: calculatePotentialBid(inputs.tos_cpc, inputs.tos_acos_raw, inputs.tos_cpc, null),
                    ros: calculatePotentialBid(inputs.ros_cpc, inputs.ros_acos_raw, inputs.tos_cpc, inputs.pp_cpc),
                    pp: calculatePotentialBid(inputs.pp_cpc, inputs.pp_acos_raw, inputs.tos_cpc, inputs.ros_cpc),
                };
                const validBids = Object.values(potentialBids).filter(b => b !== null && !isNaN(b));
                if (validBids.length === 0) {
                    Object.values(outputs).forEach(cell => cell.textContent = '');
                    return;
                }
                const newBid = Math.min(...validBids);
                outputs.new_bid.textContent = `$${newBid.toFixed(2)}`;
                const calculateAdjustment = (potentialBid, newBidValue) => {
                    if (potentialBid === null || newBidValue <= 0) return 'N/A';
                    const adjustment = ((potentialBid / newBidValue) - 1) * 100;
                    const sign = adjustment >= 0 ? '+' : '';
                    const colorClass = adjustment >= 0 ? 'adjustment-up' : 'adjustment-down';
                    return `<span class="${colorClass}">${sign}${adjustment.toFixed(0)}%</span>`;
                };
                outputs.tos_adjust.innerHTML = calculateAdjustment(potentialBids.tos, newBid);
                outputs.ros_adjust.innerHTML = calculateAdjustment(potentialBids.ros, newBid);
                outputs.pp_adjust.innerHTML = calculateAdjustment(potentialBids.pp, newBid);
            }
            
            function applyConditionalFormatting(row) {
                const rules = state.sheets[state.activeSheetIndex].settings.formattingRules;
                const rowIndex = parseInt(row.dataset.rowIndex);
                const rowData = state.sheets[state.activeSheetIndex].data[rowIndex];
                
                // Reset background color, but respect manual highlight
                row.style.backgroundColor = rowData.highlight && rowData.highlight !== 'none' ? `var(--highlight-${rowData.highlight})` : '';

                if (!rules || rules.length === 0) return;
                
                const calcRowData = {
                    name: row.querySelector('.campaign-name-input').value,
                    tos_cpc: parseCurrency(row.querySelector('.tos-cpc').value), tos_acos: parsePercentage(row.querySelector('.tos-acos').value),
                    ros_cpc: parseCurrency(row.querySelector('.ros-cpc').value), ros_acos: parsePercentage(row.querySelector('.ros-acos').value),
                    pp_cpc: parseCurrency(row.querySelector('.pp-cpc').value), pp_acos: parsePercentage(row.querySelector('.pp-acos').value),
                    new_bid: parseCurrency(row.querySelector('.new-bid').textContent), tos_adjust: parsePercentage(row.querySelector('.tos-adjust').textContent),
                    ros_adjust: parsePercentage(row.querySelector('.ros-adjust').textContent), pp_adjust: parsePercentage(row.querySelector('.pp-adjust').textContent),
                };

                for (const rule of rules) {
                    const cellValue = calcRowData[rule.column];
                    const ruleValue = (typeof cellValue === 'number' && !isNaN(cellValue)) ? parseFloat(rule.value) : rule.value;
                    if (cellValue === null || cellValue === undefined) continue;
                    let match = false;
                    switch (rule.operator) {
                        case '>': match = cellValue > ruleValue; break;
                        case '<': match = cellValue < ruleValue; break;
                        case '=': match = cellValue == ruleValue; break;
                        case '!=': match = cellValue != ruleValue; break;
                        case 'contains': match = String(cellValue).toLowerCase().includes(String(ruleValue).toLowerCase()); break;
                        case 'does not contain': match = !String(cellValue).toLowerCase().includes(String(ruleValue).toLowerCase()); break;
                    }
                    if (match) {
                        row.style.backgroundColor = rule.color;
                        break;
                    }
                }
            }

            // --- EVENT HANDLERS ---
            function addGlobalEventListeners() {
                document.getElementById('undo-btn').addEventListener('click', undo);
                document.getElementById('redo-btn').addEventListener('click', redo);
                document.getElementById('save-btn').addEventListener('click', () => {
                    saveState(false);
                    const btn = document.getElementById('save-btn');
                    btn.textContent = 'Saved!';
                    setTimeout(() => { btn.textContent = 'Save'; }, 1500);
                });
                document.getElementById('theme-switcher').addEventListener('click', toggleTheme);
                document.getElementById('main-tabs-container').addEventListener('click', handleMainTabClick);
                document.addEventListener('keydown', e => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'z') { e.preventDefault(); undo(); }
                        else if (e.key === 'y' || (e.key === 'Z' && e.shiftKey)) { e.preventDefault(); redo(); }
                    }
                });
            }

            function addCalculatorEventListeners() {
                document.getElementById('sheet-tabs-container').addEventListener('click', handleSheetTabClick);
                document.getElementById('sheet-tabs-container').addEventListener('dblclick', handleSheetTabDoubleClick);
                document.getElementById('sheet-title-input').addEventListener('change', handleSheetTitleChange);
                document.getElementById('add-row-btn').addEventListener('click', handleAddRow);
                document.getElementById('select-all-checkbox').addEventListener('change', handleSelectAll);
                document.getElementById('delete-selected-btn').addEventListener('click', handleDeleteSelected);
                document.getElementById('copy-selected-btn').addEventListener('click', handleCopySelected);
                document.getElementById('import-csv-btn').addEventListener('click', () => document.getElementById('csv-file-input').click());
                document.getElementById('csv-file-input').addEventListener('change', handleCsvImport);
                document.getElementById('export-csv-btn').addEventListener('click', handleCsvExport);
                document.getElementById('highlight-palette-container').addEventListener('click', handleHighlightClick);
                document.getElementById('campaign-table-body').addEventListener('focusin', (e) => {
                    if (e.target.matches('.input-cell')) {
                        handleFocus(e.target);
                    }
                });
            }

            function addSettingsEventListeners() {
                const settingsView = document.getElementById('settings-view');
                settingsView.addEventListener('change', handleSettingsChange);
                settingsView.addEventListener('click', handleSettingsClick);
            }
            
            function handleMainTabClick(e) {
                if (e.target.matches('.sheet-tab[data-tab]')) {
                    state.activeMainTab = e.target.dataset.tab;
                    saveState(false);
                    renderAll();
                }
            }
            
            function handleSheetTabClick(e) {
                if (e.target.matches('.sheet-tab[data-index]')) {
                    state.activeSheetIndex = parseInt(e.target.dataset.index);
                    saveState(false); // Don't record history for tab switching
                    renderAll();
                } else if (e.target.matches('.add-sheet-btn')) {
                    if (state.sheets.length < 10) {
                        const newSheetName = `Sheet ${state.sheets.length + 1}`;
                        state.sheets.push({
                            name: newSheetName, title: `New Campaign Group`,
                            data: Array(10).fill({}).map(() => createDefaultRowData()),
                            settings: { acosLogic: JSON.parse(JSON.stringify(DEFAULT_ACOS_LOGIC)), formattingRules: [] }
                        });
                        state.activeSheetIndex = state.sheets.length - 1;
                        saveState();
                        renderAll();
                    }
                }
            }

            function handleSheetTabDoubleClick(e) {
                if (e.target.matches('.sheet-tab[data-index]')) {
                    const tab = e.target;
                    const originalName = tab.textContent;
                    tab.innerHTML = `<input type="text" class="rename-input" value="${originalName}">`;
                    const input = tab.querySelector('input');
                    input.focus();
                    input.select();
                    const finishRename = () => {
                        const newName = input.value.trim();
                        if (newName) {
                            tab.textContent = newName;
                            state.sheets[state.activeSheetIndex].name = newName;
                            saveState();
                        } else {
                            tab.textContent = originalName;
                        }
                    };
                    input.addEventListener('blur', finishRename, { once: true });
                    input.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') input.blur(); });
                }
            }
            
            function handleSheetTitleChange(e) { state.sheets[state.activeSheetIndex].title = e.target.value; saveState(); }
            
            function handleFocus(input) {
                const tableBody = document.getElementById('campaign-table-body');
                tableBody.querySelectorAll('.active-row').forEach(r => r.classList.remove('active-row'));
                input.closest('tr').classList.add('active-row');
            }

            function handleInput(e, rowIndex) {
                const field = e.target.classList.contains('campaign-name-input') ? 'name' : e.target.classList[e.target.classList.length - 1];
                state.sheets[state.activeSheetIndex].data[rowIndex][field] = e.target.value;
                if(e.target.classList.contains('campaign-name-input')) handleCampaignLink(e.target);
                calculateAndFormatRow(e.target.closest('tr'));
                // No saveState here, blur will handle it for better history management.
            }

            function handleBlur(e, rowIndex) {
                const input = e.target;
                if (input.classList.contains('cpc-input')) {
                    const num = parseCurrency(input.value);
                    input.value = num !== null ? `$${num.toFixed(2)}` : '';
                } else if (input.classList.contains('acos-input') && input.value !== '000') {
                    const num = parsePercentage(input.value);
                    input.value = num !== null ? `${num}%` : '';
                }
                state.sheets[state.activeSheetIndex].data[rowIndex][input.classList[input.classList.length - 1]] = input.value;
                saveState(); // Save on blur, after formatting
                calculateAndFormatRow(input.closest('tr'));
            }

            function handleKeyNavigation(e) {
                 const key = e.key;
                if (key === 'Enter') {
                    e.preventDefault();
                    const allInputs = Array.from(document.querySelectorAll('#calculator-view .input-cell'));
                    const currentIndex = allInputs.indexOf(e.target);
                    const nextInput = allInputs[currentIndex + 1];
                    if (nextInput) {
                        nextInput.focus();
                        nextInput.select();
                    }
                } else if (key.startsWith('Arrow')) {
                    e.preventDefault();
                    const cell = e.target.closest('td');
                    const row = e.target.closest('tr');
                    const colIndex = cell.cellIndex;
                    const tbodyRowIndex = Array.from(document.getElementById('campaign-table-body').children).indexOf(row);
                    let nextCell;
                    if (key === 'ArrowUp' && tbodyRowIndex > 0) nextCell = document.getElementById('campaign-table-body').rows[tbodyRowIndex - 1].cells[colIndex];
                    else if (key === 'ArrowDown' && tbodyRowIndex < document.getElementById('campaign-table-body').rows.length - 1) nextCell = document.getElementById('campaign-table-body').rows[tbodyRowIndex + 1].cells[colIndex];
                    else if (key === 'ArrowLeft' && colIndex > 1) nextCell = cell.previousElementSibling;
                    else if (key === 'ArrowRight' && colIndex < row.cells.length - 2) nextCell = cell.nextElementSibling;
                    if (nextCell) {
                        const nextInput = nextCell.querySelector('.input-cell');
                        if (nextInput) {
                            nextInput.focus();
                            nextInput.select();
                        }
                    }
                }
            }
            function handleCampaignLink(input) { 
                const linkIcon = input.nextElementSibling;
                if (isValidURL(input.value)) {
                    linkIcon.href = input.value;
                    linkIcon.style.display = 'inline-block';
                } else {
                    linkIcon.style.display = 'none';
                }
            }
            function handleCopyResults(button) { 
                const row = button.closest('tr');
                const newBid = row.querySelector('.new-bid').textContent;
                const tosAdj = row.querySelector('.tos-adjust').textContent;
                const rosAdj = row.querySelector('.ros-adjust').textContent;
                const ppAdj = row.querySelector('.pp-adjust').textContent;
                const textToCopy = [newBid, tosAdj, rosAdj, ppAdj].join('\t');
                navigator.clipboard.writeText(textToCopy).then(() => showToast('Results copied!'));
            }
            function handleSelectAll(e) {
                document.getElementById('campaign-table-body').querySelectorAll('.row-checkbox').forEach(cb => cb.checked = e.target.checked);
                updateBulkActionButtons();
            }
            function handleDeleteSelected() { 
                const selectedIndices = Array.from(document.getElementById('campaign-table-body').querySelectorAll('.row-checkbox:checked')).map(cb => parseInt(cb.closest('tr').dataset.rowIndex));
                state.sheets[state.activeSheetIndex].data = state.sheets[state.activeSheetIndex].data.filter((_, index) => !selectedIndices.includes(index));
                while(state.sheets[state.activeSheetIndex].data.length < 10) {
                    state.sheets[state.activeSheetIndex].data.push(createDefaultRowData());
                }
                saveState();
                renderAll();
            }
            function handleCopySelected() { 
                const copies = [];
                document.getElementById('campaign-table-body').querySelectorAll('.row-checkbox:checked').forEach(cb => {
                    const rowIndex = parseInt(cb.closest('tr').dataset.rowIndex);
                    const rowData = state.sheets[state.activeSheetIndex].data[rowIndex];
                    copies.push({ ...rowData, id: Date.now() + Math.random() });
                });
                
                const data = state.sheets[state.activeSheetIndex].data;
                const firstEmptyIndex = data.findIndex(row => !row.name);
                const indexToInsert = firstEmptyIndex === -1 ? data.length : firstEmptyIndex;

                data.splice(indexToInsert, 0, ...copies);
                saveState();
                renderAll();
            }
            function handleAddRow() { 
                const data = state.sheets[state.activeSheetIndex].data;
                const firstEmptyIndex = data.findIndex(row => !row.name && row.name !== undefined);
                const indexToInsert = firstEmptyIndex === -1 ? data.length : firstEmptyIndex;
                
                data.splice(indexToInsert, 0, createDefaultRowData());
                saveState();
                renderAll();
                setTimeout(() => {
                    const newRow = document.getElementById('campaign-table-body').rows[indexToInsert];
                    if (newRow) {
                        newRow.querySelector('input').focus();
                        newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 0);
            }
            function handleCsvImport(event) { 
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const rows = text.split(/[\r\n]+/).slice(1);
                    const importedData = rows.map(rowStr => {
                        const values = rowStr.split(',');
                        if (values.length < 7) return null;
                        return {
                            id: Date.now() + Math.random(),
                            name: values[0] || '', tos_cpc: values[1] || '', tos_acos: values[2] || '',
                            ros_cpc: values[3] || '', ros_acos: values[4] || '', pp_cpc: values[5] || '', pp_acos: values[6] || '',
                        };
                    }).filter(d => d && d.name);

                    if(importedData.length > 0) {
                        const currentSheet = state.sheets[state.activeSheetIndex];
                        currentSheet.data = importedData;
                        while(currentSheet.data.length < 10) {
                            currentSheet.data.push(createDefaultRowData());
                        }
                        saveState();
                        renderAll();
                        showToast(`${importedData.length} rows imported successfully.`);
                    } else {
                        showToast('Could not import data. Check CSV format.', 4000);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            }
            function handleCsvExport() { 
                const headers = ['name', 'tos_cpc', 'tos_acos', 'ros_cpc', 'ros_acos', 'pp_cpc', 'pp_acos', 'new_bid', 'tos_adjust', 'ros_adjust', 'pp_adjust'];
                let csvContent = headers.join(',') + '\n';
                
                const rows = Array.from(document.getElementById('campaign-table-body').querySelectorAll('tr'));
                const dataToExport = rows.map(row => {
                    const rowData = {
                        name: `"${row.querySelector('.campaign-name-input').value.replace(/"/g, '""')}"`,
                        tos_cpc: row.querySelector('.tos-cpc').value, tos_acos: row.querySelector('.tos-acos').value,
                        ros_cpc: row.querySelector('.ros-cpc').value, ros_acos: row.querySelector('.ros-acos').value,
                        pp_cpc: row.querySelector('.pp-cpc').value, pp_acos: row.querySelector('.pp-acos').value,
                        new_bid: row.querySelector('.new-bid').textContent, tos_adjust: row.querySelector('.tos-adjust').textContent,
                        ros_adjust: row.querySelector('.ros-adjust').textContent, pp_adjust: row.querySelector('.pp-adjust').textContent,
                    };
                    return headers.map(h => rowData[h]).join(',');
                }).join('\n');

                csvContent += dataToExport;
                const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${state.sheets[state.activeSheetIndex].name}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast('Data exported.');
            }
            function handleSettingsChange(e) { 
                const target = e.target;
                const currentSettings = state.sheets[state.activeSheetIndex].settings;
                
                if (target.matches('.acos-logic-input')) {
                    const index = parseInt(target.dataset.index);
                    const field = target.dataset.field;
                    let value = parseFloat(target.value);
                    if(isNaN(value)) value = 0;
                    if (field === 'decrease') value /= 100;
                    currentSettings.acosLogic[index][field] = value;
                    currentSettings.acosLogic.sort((a,b) => a.min - b.min); // Keep sorted
                    renderAcosLogicTable(); // Re-render to show sorted order
                } else if (target.matches('.formatting-rule-input')) {
                    const index = parseInt(target.dataset.index);
                    const field = target.dataset.field;
                    currentSettings.formattingRules[index][field] = target.value;
                }
                saveState();
                renderAll(); // Re-render to apply new rules
            }
            function handleSettingsClick(e) { 
                const target = e.target.closest('button');
                if (!target) return;
                const currentSettings = state.sheets[state.activeSheetIndex].settings;

                if (target.id === 'add-logic-rule-btn') {
                    currentSettings.acosLogic.push({ min: 100, max: 110, decrease: 0.70 });
                    currentSettings.acosLogic.sort((a,b) => a.min - b.min);
                    renderAcosLogicTable();
                } else if (target.matches('.remove-logic-rule-btn')) {
                    currentSettings.acosLogic.splice(parseInt(target.dataset.index), 1);
                    renderAcosLogicTable();
                } else if (target.id === 'add-formatting-rule-btn') {
                    currentSettings.formattingRules.push({ column: 'new_bid', operator: '>', value: '1.00', color: '#fecaca' });
                    renderConditionalFormattingTable();
                } else if (target.matches('.remove-formatting-rule-btn')) {
                    currentSettings.formattingRules.splice(parseInt(target.dataset.index), 1);
                    renderConditionalFormattingTable();
                } else if (target.id === 'save-preset-btn') {
                    const name = document.getElementById('preset-name-input').value.trim();
                    if (name) {
                        state.presets[name] = JSON.parse(JSON.stringify(currentSettings));
                        document.getElementById('preset-name-input').value = '';
                        showToast(`Preset "${name}" saved.`);
                        renderPresets();
                    }
                } else if (target.id === 'load-preset-btn') {
                    const name = document.getElementById('load-preset-select').value;
                    if (name && state.presets[name]) {
                        state.sheets[state.activeSheetIndex].settings = JSON.parse(JSON.stringify(state.presets[name]));
                        showToast(`Preset "${name}" loaded.`);
                        renderSettings();
                        renderAll();
                    }
                } else if (target.id === 'delete-preset-btn') {
                    const name = document.getElementById('load-preset-select').value;
                    if (name && name !== "Default") {
                        showConfirmationModal(`Are you sure you want to delete the "${name}" preset?`, () => {
                            delete state.presets[name];
                            showToast(`Preset "${name}" deleted.`);
                            renderPresets();
                            saveState();
                        });
                    } else if (name === "Default") {
                        showToast("Cannot delete the Default preset.", 4000);
                    }
                } else if (target.id === 'apply-preset-all-btn') {
                    showConfirmationModal("Apply current settings to all sheets? This cannot be undone.", () => {
                        state.sheets.forEach(sheet => {
                            sheet.settings = JSON.parse(JSON.stringify(currentSettings));
                        });
                        showToast(`Settings applied to all sheets.`);
                        saveState();
                    });
                }
                saveState();
            }
            
            function handleHighlightClick(e) {
                if (e.target.matches('.color-swatch')) {
                    const color = e.target.dataset.color;
                    const tableBody = document.getElementById('campaign-table-body');
                    tableBody.querySelectorAll('.row-checkbox:checked').forEach(cb => {
                        const row = cb.closest('tr');
                        const rowIndex = parseInt(row.dataset.rowIndex);
                        state.sheets[state.activeSheetIndex].data[rowIndex].highlight = color;
                        row.style.backgroundColor = color !== 'none' ? `var(--highlight-${color})` : '';
                    });
                    saveState();
                }
            }

            // --- INITIALIZATION ---
            function init() {
                loadState();
                addGlobalEventListeners();
                renderAll();
            }

            init();
        });
    })();
    </script>
</body>
</html>
