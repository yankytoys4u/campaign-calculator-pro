acity: 0.7; }
        .highlight-palette { display: flex; gap: 0.5rem; align-items: center; }border-gray-300">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th class="w-12"><input type="checkbox" id="select-all-checkbox"></th>
                                <th class="bg-slate-100">Campaign Name</th>
                                <th class="header-tos">TOS CPC</th><th class="header-tos">TOS ACOS %</th>
                                <th class="header-ros">ROS CPC</th><th class="header-ros">ROS ACOS %</th>
                                <th class="header-pp">PP CPC</th><th class="header-pp">PP ACOS %</th>ht Mode:</strong> Use the sun/moon icon to toggle the theme.</li>
                <li><strong>Manual Highlighting:</strong> Select rows with the checkbox, then choose a color from the palette that appears.</li>
            </ul>reset-name-input" placeholder="New Preset Name" class="input-cell flex-grow">
                        <button id="save-preset-btn" class="btn btn-primary">Save</button>
            const parseCurrency = (value) => parseFloat(String(value).replace(/[$,]/g, '')) || null;
            const parsePercentage = (value) => parseFloat(String(value).replace(/[%]/g, '')) || null;
            
            function showToast(message, duration = 3000) {
                const toast = document.getElementById('toast-container');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), duration);
            }

            function showConfirmationModal(message, onConfirm) {
                const modal = document.getElementById('confirmation-modal');
                modal.querySelector('#modal-message').textContent = message;
                const confirmBtn = modal.querySelector('#modal-confirm-btn');
                const cancelBtn = modal.querySelector('#modal-cancel-btn');
                
                const confirmHandler = () => { onConfirm(); hideModal(); };
                const hideModal = () => {
                    modal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', hideModal);
                };
                
                confirmBtn.addEventListener('click', confirmHandler, { once: true });
                cancelBtn.addEventListener('click', hideModal, { once: true });
                modal.classList.remove('hidden');
            }

            function isValidURL(string) {
                try { new URL(string); return true; } catch (_) { return false; }
            }
            
            function createDefaultRowData() {
                return { id: Date.now() + Math.random(), name: '', tos_cpc: '', tos_acos: '', ros_cpc: '', ros_acos: '', pp_cpc: '', pp_acos: '', highlight: 'none' };
            }

            // --- HISTORY (UNDO/REDO) MANAGEMENT ---
            function recordHistory(sourceState) {
                history = history.slice(0, historyIndex + 1);
                history.push(JSON.parse(JSON.stringify(sourceState)));
                historyIndex++;
                updateUndoRedoButtons();
            }

            function undo() {
                if (historyIndex > 0) {
                    historyIndex--;
                    state = JSON.parse(JSON.stringify(history[historyIndex]));
                    renderAll();
                    updateUndoRedoButtons();
                }
            }

            function redo() {
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    state = JSON.parse(JSON.stringify(history[historyIndex]));
                    renderAll();
                    updateUndoRedoButtons();
                }
            }

            function updateUndoRedoButtons() {
                document.getElementById('undo-btn').disabled = historyIndex <= 0;
                document.getElementById('redo-btn').disabled = historyIndex >= history.length - 1;
            }

            // --- STATE PERSISTENCE ---
            function saveState(record = true) {
                if (record) recordHistory(state);
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                } catch (e) {
                    console.error("Error saving state:", e);
                    showToast("Error saving data.", 5000);
                }
            }

            function loadState() {
                const savedState = localStorage.getItem(STORAGE_KEY);
                if (savedState) {
                    state = JSON.parse(savedState);
                    // Compatibility checks for new features
                    if (!state.theme) state.theme = 'light';
                    if (!state.presets) state.presets = {};
                    state.sheets.forEach(sheet => {
                        if (!sheet.title) sheet.title = `Untitled Sheet`;
                        if (!sheet.settings) sheet.settings = { acosLogic: JSON.parse(JSON.stringify(DEFAULT_ACOS_LOGIC)), formattingRules: [] };
                        sheet.data.forEach(row => { if (!row.highlight) row.highlight = 'none'; });
                    });
                } else {
                    state = {
                        theme: 'light', activeMainTab: 'calculator', activeSheetIndex: 0, sheets: [],
                        presets: { "Default": { acosLogic: JSON.parse(JSON.stringify(DEFAULT_ACOS_LOGIC)), formattingRules: [] } }
                    };
                    for (let i = 1; i <= 5; i++) {
                        state.sheets.push({
                            name: `Sheet ${i}`, title: `Campaign Group ${i}`,
                            data: Array(10).fill({}).map(() => createDefaultRowData()),
                            settings: { acosLogic: JSON.parse(JSON.stringify(DEFAULT_ACOS_LOGIC)), formattingRules: [] }
                        });
                    }
                }
                recordHistory(state); // Initial state for undo
            }

            // --- THEME MANAGEMENT ---
            function applyTheme() {
                const body = document.body;
                const sunIcon = document.getElementById('theme-icon-sun');
                const moonIcon = document.getElementById('theme-icon-moon');
                if (state.theme === 'dark') {
                    body.classList.add('dark');
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                } else {
                    body.classList.remove('dark');
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                }
            }

            function toggleTheme() {
                state.theme = state.theme === 'light' ? 'dark' : 'light';
                applyTheme();
                saveState(); // Record theme change in history
            }
            
            // --- RENDER FUNCTIONS ---
            function renderAll() {
                applyTheme();
                renderMainView();
                updateUndoRedoButtons();
            }

            function renderMainView() {
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = ''; // Clear previous view
                const templateId = `${state.activeMainTab}-view-template`;
                const template = document.getElementById(templateId);
                if (template) {
                    mainContent.appendChild(template.content.cloneNode(true));
                    if (state.activeMainTab === 'calculator') {
                        renderSheetTabs();
                        renderSheetContent();
                        addCalculatorEventListeners();
                    } else if (state.activeMainTab === 'settings') {
                        renderSettings();
                        addSettingsEventListeners();
                    }
                }
                document.querySelectorAll('#main-tabs-container .sheet-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === state.activeMainTab);
                });
            }

            function renderSheetTabs() {
                const container = document.getElementById('sheet-tabs-container');
                container.innerHTML = '';
                state.sheets.forEach((sheet, index) => {
                    const tab = document.createElement('div');
                    tab.className = 'sheet-tab';
                    tab.classList.toggle('active', index === state.activeSheetIndex);
                    tab.textContent = sheet.name;
                    tab.dataset.index = index;
                    container.appendChild(tab);
                });
                const addBtn = document.createElement('button');
                addBtn.textContent = '+';
                addBtn.className = 'sheet-tab add-sheet-btn';
                addBtn.title = 'Add new sheet';
                if (state.sheets.length >= 10) addBtn.disabled = true;
                container.appendChild(addBtn);
            }
            
            function renderSheetContent() {
                const currentSheet = state.sheets[state.activeSheetIndex];
                if (!currentSheet) return;
                
                document.getElementById('sheet-title-input').value = currentSheet.title;
                const tableBody = document.getElementById('campaign-table-body');
                tableBody.innerHTML = '';
                currentSheet.data.forEach((rowData, index) => {
                    const row = createRowElement(rowData, index);
                    tableBody.appendChild(row);
                });
                document.getElementById('select-all-checkbox').checked = false;
                updateBulkActionButtons();
            }

            function renderSettings() {
                const currentSheet = state.sheets[state.activeSheetIndex];
                document.getElementById('settings-sheet-name').textContent = currentSheet.name;
                renderAcosLogicTable();
                renderConditionalFormattingTable();
                renderPresets();
            }
            
            function renderAcosLogicTable() {
                const container = document.getElementById('acos-logic-table-container');
                container.innerHTML = `<div class="grid grid-cols-4 gap-2 font-semibold mb-2 px-2">
                    <span>Min ACOS %</span><span>Max ACOS %</span><span>Decrease %</span><span></span></div>`;
                const logicTable = state.sheets[state.activeSheetIndex].settings.acosLogic;
                logicTable.forEach((rule, index) => {
                    const div = document.createElement('div');
                    div.className = 'grid grid-cols-4 gap-2 items-center mb-1';
                    div.innerHTML = `
                        <input type="number" value="${rule.min}" data-index="${index}" data-field="min" class="input-cell w-full acos-logic-input">
                        <input type="number" value="${rule.max}" data-index="${index}" data-field="max" class="input-cell w-full acos-logic-input">
                        <input type="number" step="0.01" value="${rule.decrease * 100}" data-index="${index}" data-field="decrease" class="input-cell w-full acos-logic-input">
                        <button data-index="${index}" class="btn btn-danger remove-logic-rule-btn p-2 leading-none">X</button>
                    `;
                    container.appendChild(div);
                });
            }

            function renderConditionalFormattingTable() {
                 const container = document.getElementById('conditional-formatting-container');
                container.innerHTML = `<div class="grid grid-cols-5 gap-2 font-semibold mb-2 px-2">
                    <span>Column</span><span>Operator</span><span>Value</span><span>Color</span><span></span></div>`;
                const rules = state.sheets[state.activeSheetIndex].settings.formattingRules;
                rules.forEach((rule, index) => {
                    const div = document.createElement('div');
                    div.className = 'grid grid-cols-5 gap-2 items-center mb-1';
                    const columns = ['name', 'tos_cpc', 'tos_acos', 'ros_cpc', 'ros_acos', 'pp_cpc', 'pp_acos', 'new_bid', 'tos_adjust', 'ros_adjust', 'pp_adjust'];
                    const operators = ['>', '<', '=', '!=', 'contains', 'does not contain'];
                    div.innerHTML = `
                        <select data-index="${index}" data-field="column" class="input-cell w-full formatting-rule-input">${columns.map(c => `<option value="${c}" ${rule.column === c ? 'selected' : ''}>${c}</option>`).join('')}</select>
                        <select data-index="${index}" data-field="operator" class="input-cell w-full formatting-rule-input">${operators.map(o => `<option value="${o}" ${rule.operator === o ? 'selected' : ''}>${o}</option>`).join('')}</select>
                        <input type="text" value="${rule.value}" data-index="${index}" data-field="value" class="input-cell w-full formatting-rule-input">
                        <input type="color" value="${rule.color}" data-index="${index}" data-field="color" class="input-cell w-full p-1 formatting-rule-input">
                        <button data-index="${index}" class="btn btn-danger remove-formatting-rule-btn p-2 leading-none">X</button>
                    `;
                    container.appendChild(div);
                });
            }

            function renderPresets() {
                const select = document.getElementById('load-preset-select');
                select.innerHTML = Object.keys(state.presets).map(p => `<option value="${p}">${p}</option>`).join('');
            }
            
            function updateBulkActionButtons() {
                const container = document.getElementById('bulk-actions-container');
                if (!container) return;
                const tableBody = document.getElementById('campaign-table-body');
                const selectedCount = tableBody.querySelectorAll('.row-checkbox:checked').length;
                container.querySelector('#delete-selected-btn').disabled = selectedCount === 0;
                container.querySelector('#copy-selected-btn').disabled = selectedCount === 0;
                container.querySelector('#highlight-palette-container').classList.toggle('hidden', selectedCount === 0);
                const selectAll = document.getElementById('select-all-checkbox');
                if (selectAll) {
                    const totalRows = tableBody.querySelectorAll('.row-checkbox').length;
                    selectAll.checked = selectedCount > 0 && totalRows > 0 && selectedCount === totalRows;
                }
            }

            // --- ROW ELEMENT & LOGIC ---
            function createRowElement(data, rowIndex) {
                const row = document.createElement('tr');
                row.dataset.rowIndex = rowIndex;
                if (data.highlight && data.highlight !== 'none') {
                    row.style.backgroundColor = `var(--highlight-${data.highlight})`;
                }
                row.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox"></td>
                    <td>
                        <div class="campaign-name-cell-container">
                            <input type="text" class="input-cell campaign-name-input" placeholder="Campaign Name or URL" value="${data.name || ''}">
                            <a class="link-icon" target="_blank" rel="noopener noreferrer">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-4.5 0V6.75A2.25 2.25 0 0115.75 4.5h1.5m-3 0h3m-3 0a2.25 2.25 0 00-2.25 2.25v1.5m3 0a2.25 2.25 0 002.25-2.25v-1.5m-6 6.75h6.75" /></svg>
                            </a>
                        </div>
                    </td>
                    <td class="col-tos"><input type="text" class="input-cell cpc-input tos-cpc" placeholder="$0.00" value="${data.tos_cpc || ''}"></td>
                    <td class="col-tos"><input type="text" class="input-cell acos-input tos-acos" placeholder="0%" value="${data.tos_acos || ''}"></td>
                    <td class="col-ros"><input type="text" class="input-cell cpc-input ros-cpc" placeholder="$0.00" value="${data.ros_cpc || ''}"></td>
                    <td class="col-ros"><input type="text" class="input-cell acos-input ros-acos" placeholder="0%" value="${data.ros_acos || ''}"></td>
                    <td class="col-pp"><input type="text" class="input-cell cpc-input pp-cpc" placeholder="$0.00" value="${data.pp_cpc || ''}"></td>
                    <td class="col-pp"><input type="text" class="input-cell acos-input pp-acos" placeholder="0%" value="${data.pp_acos || ''}"></td>
                    <td class="output-cell new-bid"></td>
                    <td class="output-cell tos-adjust"></td>
                    <td class="output-cell ros-adjust"></td>
                    <td class="output-cell pp-adjust"></td>
                    <td>
                        <button class="action-btn copy-results-btn" title="Copy Results">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" /></svg>
                        </button>
                    </td>
                `;
                attachRowEventListeners(row, rowIndex);
                calculateAndFormatRow(row);
                return row;
            }

            function attachRowEventListeners(row, rowIndex) {
                const inputs = row.querySelectorAll('input.input-cell');
                inputs.forEach(input => {
                    input.addEventListener('input', (e) => handleInput(e, rowIndex));
                    input.addEventListener('focus', (e) => handleFocus(e.target));
                    input.addEventListener('blur', (e) => handleBlur(e, rowIndex));
                    input.addEventListener('keydown', handleKeyNavigation);
                });
                row.querySelector('.row-checkbox').addEventListener('change', updateBulkActionButtons);
                row.querySelector('.copy-results-btn').addEventListener('click', (e) => handleCopyResults(e.currentTarget));
                handleCampaignLink(row.querySelector('.campaign-name-input'));
            }

            function calculateAndFormatRow(row) {
                calculateRow(row);
                applyConditionalFormatting(row);
            }

            function calculateRow(row) {
                const acosLogicTable = state.sheets[state.activeSheetIndex].settings.acosLogic;
                const getDecreasePercent = (acos) => {
                    if (acos === null || isNaN(acos)) return 0;
                    const rule = acosLogicTable.find(r => acos >= r.min && acos <= r.max);
                    return rule ? rule.decrease : (acosLogicTable[acosLogicTable.length - 1]?.decrease || 0.65);
                };
                const inputs = {
                    tos_cpc: parseCurrency(row.querySelector('.tos-cpc').value), tos_acos_raw: row.querySelector('.tos-acos').value,
                    ros_cpc: parseCurrency(row.querySelector('.ros-cpc').value), ros_acos_raw: row.querySelector('.ros-acos').value,
                    pp_cpc: parseCurrency(row.querySelector('.pp-cpc').value), pp_acos_raw: row.querySelector('.pp-acos').value,
                };
                const outputs = {
                    new_bid: row.querySelector('.new-bid'), tos_adjust: row.querySelector('.tos-adjust'),
                    ros_adjust: row.querySelector('.ros-adjust'), pp_adjust: row.querySelector('.pp-adjust'),
                };
                const calculatePotentialBid = (cpc, acos_raw, primary_cpc, secondary_cpc) => {
                    if (cpc === null || acos_raw === '') return null;
                    if (acos_raw === '000') {
                        if (primary_cpc) return primary_cpc / 3;
                        if (secondary_cpc) return secondary_cpc / 2;
                        return null;
                    }
                    const acos = parsePercentage(acos_raw);
                    if (isNaN(acos) || acos === null) return null;
                    return cpc * (1 - getDecreasePercent(acos));
                };
                const potentialBids = {
                    tos: calculatePotentialBid(inputs.tos_cpc, inputs.tos_acos_raw, inputs.tos_cpc, null),
                    ros: calculatePotentialBid(inputs.ros_cpc, inputs.ros_acos_raw, inputs.tos_cpc, inputs.pp_cpc),
                    pp: calculatePotentialBid(inputs.pp_cpc, inputs.pp_acos_raw, inputs.tos_cpc, inputs.ros_cpc),
                };
                const validBids = Object.values(potentialBids).filter(b => b !== null && !isNaN(b));
                if (validBids.length === 0) {
                    Object.values(outputs).forEach(cell => cell.textContent = '');
                    return;
                }
                const newBid = Math.min(...validBids);
                outputs.new_bid.textContent = `$${newBid.toFixed(2)}`;
                const calculateAdjustment = (potentialBid, newBidValue) => {
                    if (potentialBid === null || newBidValue <= 0) return 'N/A';
                    const adjustment = ((potentialBid / newBidValue) - 1) * 100;
                    const sign = adjustment >= 0 ? '+' : '';
                    const colorClass = adjustment >= 0 ? 'adjustment-up' : 'adjustment-down';
                    return `<span class="${colorClass}">${sign}${adjustment.toFixed(0)}%</span>`;
                };
                outputs.tos_adjust.innerHTML = calculateAdjustment(potentialBids.tos, newBid);
                outputs.ros_adjust.innerHTML = calculateAdjustment(potentialBids.ros, newBid);
                outputs.pp_adjust.innerHTML = calculateAdjustment(potentialBids.pp, newBid);
            }
            
            function applyConditionalFormatting(row) {
                const rules = state.sheets[state.activeSheetIndex].settings.formattingRules;
                const rowIndex = parseInt(row.dataset.rowIndex);
                const rowData = state.sheets[state.activeSheetIndex].data[rowIndex];
                
                // Reset background color, but respect manual highlight
                row.style.backgroundColor = rowData.highlight && rowData.highlight !== 'none' ? `var(--highlight-${rowData.highlight})` : '';

                if (!rules || rules.length === 0) return;
                
                const calcRowData = {
                    name: row.querySelector('.campaign-name-input').value,
                    tos_cpc: parseCurrency(row.querySelector('.tos-cpc').value), tos_acos: parsePercentage(row.querySelector('.tos-acos').value),
                    ros_cpc: parseCurrency(row.querySelector('.ros-cpc').value), ros_acos: parsePercentage(row.querySelector('.ros-acos').value),
                    pp_cpc: parseCurrency(row.querySelector('.pp-cpc').value), pp_acos: parsePercentage(row.querySelector('.pp-acos').value),
                    new_bid: parseCurrency(row.querySelector('.new-bid').textContent), tos_adjust: parsePercentage(row.querySelector('.tos-adjust').textContent),
                    ros_adjust: parsePercentage(row.querySelector('.ros-adjust').textContent), pp_adjust: parsePercentage(row.querySelector('.pp-adjust').textContent),
                };

                for (const rule of rules) {
                    const cellValue = calcRowData[rule.column];
                    const ruleValue = (typeof cellValue === 'number' && !isNaN(cellValue)) ? parseFloat(rule.value) : rule.value;
                    if (cellValue === null || cellValue === undefined) continue;
                    let match = false;
                    switch (rule.operator) {
                        case '>': match = cellValue > ruleValue; break;
                        case '<': match = cellValue < ruleValue; break;
                        case '=': match = cellValue == ruleValue; break;
                        case '!=': match = cellValue != ruleValue; break;
                        case 'contains': match = String(cellValue).toLowerCase().includes(String(ruleValue).toLowerCase()); break;
                        case 'does not contain': match = !String(cellValue).toLowerCase().includes(String(ruleValue).toLowerCase()); break;
                    }
                    if (match) {
                        row.style.backgroundColor = rule.color;
                        break;
                    }
                }
            }

            // --- EVENT HANDLERS ---
            function addGlobalEventListeners() {
                document.getElementById('undo-btn').addEventListener('click', undo);
                document.getElementById('redo-btn').addEventListener('click', redo);
                document.getElementById('save-btn').addEventListener('click', () => {
                    saveState(false);
                    const btn = document.getElementById('save-btn');
                    btn.textContent = 'Saved!';
                    setTimeout(() => { btn.textContent = 'Save'; }, 1500);
                });
                document.getElementById('theme-switcher').addEventListener('click', toggleTheme);
                document.getElementById('main-tabs-container').addEventListener('click', handleMainTabClick);
                document.addEventListener('keydown', e => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'z') { e.preventDefault(); undo(); }
                        else if (e.key === 'y' || (e.key === 'Z' && e.shiftKey)) { e.preventDefault(); redo(); }
                    }
                });
            }

            function addCalculatorEventListeners() {
                document.getElementById('sheet-tabs-container').addEventListener('click', handleSheetTabClick);
                document.getElementById('sheet-tabs-container').addEventListener('dblclick', handleSheetTabDoubleClick);
                document.getElementById('sheet-title-input').addEventListener('change', handleSheetTitleChange);
                document.getElementById('add-row-btn').addEventListener('click', handleAddRow);
                document.getElementById('select-all-checkbox').addEventListener('change', handleSelectAll);
                document.getElementById('delete-selected-btn').addEventListener('click', handleDeleteSelected);
                document.getElementById('copy-selected-btn').addEventListener('click', handleCopySelected);
                document.getElementById('import-csv-btn').addEventListener('click', () => document.getElementById('csv-file-input').click());
                document.getElementById('csv-file-input').addEventListener('change', handleCsvImport);
                document.getElementById('export-csv-btn').addEventListener('click', handleCsvExport);
                document.getElementById('highlight-palette-container').addEventListener('click', handleHighlightClick);
                document.getElementById('campaign-table-body').addEventListener('focusin', (e) => {
                    if (e.target.matches('.input-cell')) {
                        handleFocus(e.target);
                    }
                });
            }

            function addSettingsEventListeners() {
                const settingsView = document.getElementById('settings-view');
                settingsView.addEventListener('change', handleSettingsChange);
                settingsView.addEventListener('click', handleSettingsClick);
            }
            
            function handleMainTabClick(e) {
                if (e.target.matches('.sheet-tab[data-tab]')) {
                    state.activeMainTab = e.target.dataset.tab;
                    saveState(false);
                    renderAll();
                }
            }
            
            function handleSheetTabClick(e) {
                if (e.target.matches('.sheet-tab[data-index]')) {
                    state.activeSheetIndex = parseInt(e.target.dataset.index);
                    saveState(false); // Don't record history for tab switching
                    renderAll();
                } else if (e.target.matches('.add-sheet-btn')) {
                    if (state.sheets.length < 10) {
                        const newSheetName = `Sheet ${state.sheets.length + 1}`;
                        state.sheets.push({
                            name: newSheetName, title: `New Campaign Group`,
                            data: Array(10).fill({}).map(() => createDefaultRowData()),
                            settings: { acosLogic: JSON.parse(JSON.stringify(DEFAULT_ACOS_LOGIC)), formattingRules: [] }
                        });
                        state.activeSheetIndex = state.sheets.length - 1;
                        saveState();
                        renderAll();
                    }
                }
            }

            function handleSheetTabDoubleClick(e) {
                if (e.target.matches('.sheet-tab[data-index]')) {
                    const tab = e.target;
                    const originalName = tab.textContent;
                    tab.innerHTML = `<input type="text" class="rename-input" value="${originalName}">`;
                    const input = tab.querySelector('input');
                    input.focus();
                    input.select();
                    const finishRename = () => {
                        const newName = input.value.trim();
                        if (newName) {
                            tab.textContent = newName;
                            state.sheets[state.activeSheetIndex].name = newName;
                            saveState();
                        } else {
                            tab.textContent = originalName;
                        }
                    };
                    input.addEventListener('blur', finishRename, { once: true });
                    input.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') input.blur(); });
                }
            }
            
            function handleSheetTitleChange(e) { state.sheets[state.activeSheetIndex].title = e.target.value; saveState(); }
            
            function handleFocus(input) {
                const tableBody = document.getElementById('campaign-table-body');
                tableBody.querySelectorAll('.active-row').forEach(r => r.classList.remove('active-row'));
                input.closest('tr').classList.add('active-row');
            }

            function handleInput(e, rowIndex) {
                const field = e.target.classList.contains('campaign-name-input') ? 'name' : e.target.classList[e.target.classList.length - 1];
                state.sheets[state.activeSheetIndex].data[rowIndex][field] = e.target.value;
                if(e.target.classList.contains('campaign-name-input')) handleCampaignLink(e.target);
                calculateAndFormatRow(e.target.closest('tr'));
                // No saveState here, blur will handle it for better history management.
            }

            function handleBlur(e, rowIndex) {
                const input = e.target;
                if (input.classList.contains('cpc-input')) {
                    const num = parseCurrency(input.value);
                    input.value = num !== null ? `$${num.toFixed(2)}` : '';
                } else if (input.classList.contains('acos-input') && input.value !== '000') {
                    const num = parsePercentage(input.value);
                    input.value = num !== null ? `${num}%` : '';
                }
                state.sheets[state.activeSheetIndex].data[rowIndex][input.classList[input.classList.length - 1]] = input.value;
                saveState(); // Save on blur, after formatting
                calculateAndFormatRow(input.closest('tr'));
            }

            function handleKeyNavigation(e) {
                 const key = e.key;
                if (key === 'Enter') {
                    e.preventDefault();
                    const allInputs = Array.from(document.querySelectorAll('#calculator-view .input-cell'));
                    const currentIndex = allInputs.indexOf(e.target);
                    const nextInput = allInputs[currentIndex + 1];
                    if (nextInput) {
                        nextInput.focus();
                        nextInput.select();
                    }
                } else if (key.startsWith('Arrow')) {
                    e.preventDefault();
                    const cell = e.target.closest('td');
                    const row = e.target.closest('tr');
                    const colIndex = cell.cellIndex;
                    const tbodyRowIndex = Array.from(document.getElementById('campaign-table-body').children).indexOf(row);
                    let nextCell;
                    if (key === 'ArrowUp' && tbodyRowIndex > 0) nextCell = document.getElementById('campaign-table-body').rows[tbodyRowIndex - 1].cells[colIndex];
                    else if (key === 'ArrowDown' && tbodyRowIndex < document.getElementById('campaign-table-body').rows.length - 1) nextCell = document.getElementById('campaign-table-body').rows[tbodyRowIndex + 1].cells[colIndex];
                    else if (key === 'ArrowLeft' && colIndex > 1) nextCell = cell.previousElementSibling;
                    else if (key === 'ArrowRight' && colIndex < row.cells.length - 2) nextCell = cell.nextElementSibling;
                    if (nextCell) {
                        const nextInput = nextCell.querySelector('.input-cell');
                        if (nextInput) {
                            nextInput.focus();
                            nextInput.select();
                        }
                    }
                }
            }
            function handleCampaignLink(input) { 
                const linkIcon = input.nextElementSibling;
                if (isValidURL(input.value)) {
                    linkIcon.href = input.value;
                    linkIcon.style.display = 'inline-block';
                } else {
                    linkIcon.style.display = 'none';
                }
            }
            function handleCopyResults(button) { 
                const row = button.closest('tr');
                const newBid = row.querySelector('.new-bid').textContent;
                const tosAdj = row.querySelector('.tos-adjust').textContent;
                const rosAdj = row.querySelector('.ros-adjust').textContent;
                const ppAdj = row.querySelector('.pp-adjust').textContent;
                const textToCopy = [newBid, tosAdj, rosAdj, ppAdj].join('\t');
                navigator.clipboard.writeText(textToCopy).then(() => showToast('Results copied!'));
            }
            function handleSelectAll(e) {
                document.getElementById('campaign-table-body').querySelectorAll('.row-checkbox').forEach(cb => cb.checked = e.target.checked);
                updateBulkActionButtons();
            }
            function handleDeleteSelected() { 
                const selectedIndices = Array.from(document.getElementById('campaign-table-body').querySelectorAll('.row-checkbox:checked')).map(cb => parseInt(cb.closest('tr').dataset.rowIndex));
                state.sheets[state.activeSheetIndex].data = state.sheets[state.activeSheetIndex].data.filter((_, index) => !selectedIndices.includes(index));
                while(state.sheets[state.activeSheetIndex].data.length < 10) {
                    state.sheets[state.activeSheetIndex].data.push(createDefaultRowData());
                }
                saveState();
                renderAll();
            }
            function handleCopySelected() { 
                const copies = [];
                document.getElementById('campaign-table-body').querySelectorAll('.row-checkbox:checked').forEach(cb => {
                    const rowIndex = parseInt(cb.closest('tr').dataset.rowIndex);
                    const rowData = state.sheets[state.activeSheetIndex].data[rowIndex];
                    copies.push({ ...rowData, id: Date.now() + Math.random() });
                });
                
                const data = state.sheets[state.activeSheetIndex].data;
                const firstEmptyIndex = data.findIndex(row => !row.name);
                const indexToInsert = firstEmptyIndex === -1 ? data.length : firstEmptyIndex;

                data.splice(indexToInsert, 0, ...copies);
                saveState();
                renderAll();
            }
            function handleAddRow() { 
                const data = state.sheets[state.activeSheetIndex].data;
                const firstEmptyIndex = data.findIndex(row => !row.name && row.name !== undefined);
                const indexToInsert = firstEmptyIndex === -1 ? data.length : firstEmptyIndex;
                
                data.splice(indexToInsert, 0, createDefaultRowData());
                saveState();
                renderAll();
                setTimeout(() => {
                    const newRow = document.getElementById('campaign-table-body').rows[indexToInsert];
                    if (newRow) {
                        newRow.querySelector('input').focus();
                        newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 0);
            }
            function handleCsvImport(event) { 
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const rows = text.split(/[\r\n]+/).slice(1);
                    const importedData = rows.map(rowStr => {
                        const values = rowStr.split(',');
                        if (values.length < 7) return null;
                        return {
                            id: Date.now() + Math.random(),
                            name: values[0] || '', tos_cpc: values[1] || '', tos_acos: values[2] || '',
                            ros_cpc: values[3] || '', ros_acos: values[4] || '', pp_cpc: values[5] || '', pp_acos: values[6] || '',
                        };
                    }).filter(d => d && d.name);

                    if(importedData.length > 0) {
                        const currentSheet = state.sheets[state.activeSheetIndex];
                        currentSheet.data = importedData;
                        while(currentSheet.data.length < 10) {
                            currentSheet.data.push(createDefaultRowData());
                        }
                        saveState();
                        renderAll();
                        showToast(`${importedData.length} rows imported successfully.`);
                    } else {
                        showToast('Could not import data. Check CSV format.', 4000);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            }
            function handleCsvExport() { 
                const headers = ['name', 'tos_cpc', 'tos_acos', 'ros_cpc', 'ros_acos', 'pp_cpc', 'pp_acos', 'new_bid', 'tos_adjust', 'ros_adjust', 'pp_adjust'];
                let csvContent = headers.join(',') + '\n';
                
                const rows = Array.from(document.getElementById('campaign-table-body').querySelectorAll('tr'));
                const dataToExport = rows.map(row => {
                    const rowData = {
                        name: `"${row.querySelector('.campaign-name-input').value.replace(/"/g, '""')}"`,
                        tos_cpc: row.querySelector('.tos-cpc').value, tos_acos: row.querySelector('.tos-acos').value,
                        ros_cpc: row.querySelector('.ros-cpc').value, ros_acos: row.querySelector('.ros-acos').value,
                        pp_cpc: row.querySelector('.pp-cpc').value, pp_acos: row.querySelector('.pp-acos').value,
                        new_bid: row.querySelector('.new-bid').textContent, tos_adjust: row.querySelector('.tos-adjust').textContent,
                        ros_adjust: row.querySelector('.ros-adjust').textContent, pp_adjust: row.querySelector('.pp-adjust').textContent,
                    };
                    return headers.map(h => rowData[h]).join(',');
                }).join('\n');

                csvContent += dataToExport;
                const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${state.sheets[state.activeSheetIndex].name}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast('Data exported.');
            }
            function handleSettingsChange(e) { 
                const target = e.target;
                const currentSettings = state.sheets[state.activeSheetIndex].settings;
                
                if (target.matches('.acos-logic-input')) {
                    const index = parseInt(target.dataset.index);
                    const field = target.dataset.field;
                    let value = parseFloat(target.value);
                    if(isNaN(value)) value = 0;
                    if (field === 'decrease') value /= 100;
                    currentSettings.acosLogic[index][field] = value;
                    currentSettings.acosLogic.sort((a,b) => a.min - b.min); // Keep sorted
                    renderAcosLogicTable(); // Re-render to show sorted order
                } else if (target.matches('.formatting-rule-input')) {
                    const index = parseInt(target.dataset.index);
                    const field = target.dataset.field;
                    currentSettings.formattingRules[index][field] = target.value;
                }
                saveState();
                renderAll(); // Re-render to apply new rules
            }
            function handleSettingsClick(e) { 
                const target = e.target.closest('button');
                if (!target) return;
                const currentSettings = state.sheets[state.activeSheetIndex].settings;

                if (target.id === 'add-logic-rule-btn') {
                    currentSettings.acosLogic.push({ min: 100, max: 110, decrease: 0.70 });
                    currentSettings.acosLogic.sort((a,b) => a.min - b.min);
                    renderAcosLogicTable();
                } else if (target.matches('.remove-logic-rule-btn')) {
                    currentSettings.acosLogic.splice(parseInt(target.dataset.index), 1);
                    renderAcosLogicTable();
                } else if (target.id === 'add-formatting-rule-btn') {
                    currentSettings.formattingRules.push({ column: 'new_bid', operator: '>', value: '1.00', color: '#fecaca' });
                    renderConditionalFormattingTable();
                } else if (target.matches('.remove-formatting-rule-btn')) {
                    currentSettings.formattingRules.splice(parseInt(target.dataset.index), 1);
                    renderConditionalFormattingTable();
                } else if (target.id === 'save-preset-btn') {
                    const name = document.getElementById('preset-name-input').value.trim();
                    if (name) {
                        state.presets[name] = JSON.parse(JSON.stringify(currentSettings));
                        document.getElementById('preset-name-input').value = '';
                        showToast(`Preset "${name}" saved.`);
                        renderPresets();
                    }
                } else if (target.id === 'load-preset-btn') {
                    const name = document.getElementById('load-preset-select').value;
                    if (name && state.presets[name]) {
                        state.sheets[state.activeSheetIndex].settings = JSON.parse(JSON.stringify(state.presets[name]));
                        showToast(`Preset "${name}" loaded.`);
                        renderSettings();
                        renderAll();
                    }
                } else if (target.id === 'delete-preset-btn') {
                    const name = document.getElementById('load-preset-select').value;
                    if (name && name !== "Default") {
                        showConfirmationModal(`Are you sure you want to delete the "${name}" preset?`, () => {
                            delete state.presets[name];
                            showToast(`Preset "${name}" deleted.`);
                            renderPresets();
                            saveState();
                        });
                    } else if (name === "Default") {
                        showToast("Cannot delete the Default preset.", 4000);
                    }
                } else if (target.id === 'apply-preset-all-btn') {
                    showConfirmationModal("Apply current settings to all sheets? This cannot be undone.", () => {
                        state.sheets.forEach(sheet => {
                            sheet.settings = JSON.parse(JSON.stringify(currentSettings));
                        });
                        showToast(`Settings applied to all sheets.`);
                        saveState();
                    });
                }
                saveState();
            }
            
            function handleHighlightClick(e) {
                if (e.target.matches('.color-swatch')) {
                    const color = e.target.dataset.color;
                    const tableBody = document.getElementById('campaign-table-body');
                    tableBody.querySelectorAll('.row-checkbox:checked').forEach(cb => {
                        const row = cb.closest('tr');
                        const rowIndex = parseInt(row.dataset.rowIndex);
                        state.sheets[state.activeSheetIndex].data[rowIndex].highlight = color;
                        row.style.backgroundColor = color !== 'none' ? `var(--highlight-${color})` : '';
                    });
                    saveState();
                }
            }

            // --- INITIALIZATION ---
            function init() {
                loadState();
                addGlobalEventListeners();
                renderAll();
            }

            init();
        });
    })();
    </script>
</body>
</html>

